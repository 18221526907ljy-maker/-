<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gossip Study: The Hailey Edit</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts: Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        .font-serif { font-family: 'Playfair Display', serif; }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #F5F5F7; }
        ::-webkit-scrollbar-thumb { background: #D1D1D1; }
        ::-webkit-scrollbar-thumb:hover { background: #8E8E93; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
    </style>
</head>
<body class="bg-[#F5F5F7] text-[#1D1D1F] font-sans selection:bg-[#E5E5E5] overflow-x-hidden">
    <div id="root"></div>

    <!-- Firebase Bridge to handle ESM and Babel correctly -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, getDoc, onSnapshot, collection
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                plus: <path d="M12 5v14M5 12h14" />,
                play: <path d="m5 3 14 9-14 9V3z" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                chevronLeft: <path d="m15 18-6-6 6-6" />,
                check: <path d="M20 6 9 17l-5-5" />,
                sparkles: <path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z" />,
                eye: (
                    <React.Fragment>
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
                    </React.Fragment>
                ),
                layers: (
                    <React.Fragment>
                        <path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/>
                        <path d="m2.6 10.33 8.58 3.9a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0 1.83l-8.58 3.91a2 2 0 0 1-1.66 0l-8.58-3.9a1 1 0 0 1 0-1.83Z"/>
                        <path d="m2.6 14.58 8.58 3.9a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0 1.83l-8.58 3.91a2 2 0 0 1-1.66 0l-8.58-3.9a1 1 0 0 1 0-1.83Z"/>
                    </React.Fragment>
                ),
                globe: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20M2 12h20" />
                    </React.Fragment>
                ),
                wallet: (
                    <React.Fragment>
                        <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/>
                        <path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4" />
                    </React.Fragment>
                ),
                arrowRight: <path d="M5 12h14m-7-7 7 7-7 7" />,
                circle: <circle cx="12" cy="12" r="10" />,
                square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const apiKey = ""; 

        const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw error;
            }
        };

        const SUBJECTS = [
            { id: 'brand', name: 'å“ç‰Œç®¡ç†', label: 'THE LABEL', color: 'from-[#2D2D2D] to-[#1A1A1A]', icon: 'layers' },
            { id: 'marketing', name: 'è¥é”€æ¸ é“', label: 'DISTRIBUTION', color: 'from-[#8E8E93] to-[#636366]', icon: 'globe' },
            { id: 'finance', name: 'è´¢åŠ¡ç®¡ç†', label: 'CAPITAL', color: 'from-[#D4C3B3] to-[#A08E7D]', icon: 'wallet' }
        ];

        const TEMPLATES = {
            question: "é¢˜ç›®ï¼š[å¤šé€‰] ä»¥ä¸‹å“ªäº›å±žäºŽå“ç‰Œèµ„äº§çš„ç»´åº¦ï¼Ÿ\nA. å“ç‰ŒçŸ¥ååº¦\nB. å“ç‰Œå¿ è¯šåº¦\nC. å“ç‰Œå…³è”æ€§\nD. å“ç‰Œæ„ŸçŸ¥è´¨é‡\nç­”æ¡ˆï¼šABCD\nè§£æžï¼šè¿™æ˜¯Haileyé£Žæ ¼çš„è§£æžæ ·ä¾‹ã€‚",
            card: "æ­£é¢ï¼šS-T-Påˆ†æžæ³•\nèƒŒé¢ï¼šå¸‚åœºç»†åˆ† (Segmentation)ã€ç›®æ ‡å¸‚åœºé€‰æ‹© (Targeting) å’Œ å¸‚åœºå®šä½ (Positioning)\nè§£æžï¼šè¿™æ˜¯Haileyé£Žæ ¼çš„è§£æžæ ·ä¾‹ã€‚"
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); 
            const [activeSubject, setActiveSubject] = useState(SUBJECTS[0]);
            const [db, setDb] = useState({ brand: { questions: [], cards: [] }, marketing: { questions: [], cards: [] }, finance: { questions: [], cards: [] } });
            const [mistakes, setMistakes] = useState([]);
            const [activeItems, setActiveItems] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [quizAnswered, setQuizAnswered] = useState(false);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [rawText, setRawText] = useState('');
            const [isParsing, setIsParsing] = useState(false);
            const [importType, setImportType] = useState('question');
            const [statusMsg, setStatusMsg] = useState('');

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'gossip-study-hailey';

            // --- Authentication Setup ---
            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(interval);
                        const sdk = window.FirebaseSDK;
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = sdk.initializeApp(firebaseConfig);
                        const auth = sdk.getAuth(app);

                        const performAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await sdk.signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await sdk.signInAnonymously(auth);
                            }
                        };
                        performAuth();
                        sdk.onAuthStateChanged(auth, setUser);
                    }
                }, 100);
                return () => clearInterval(interval);
            }, []);

            // --- Real-time Cloud Sync ---
            useEffect(() => {
                if (!user || !window.FirebaseSDK) return;
                const sdk = window.FirebaseSDK;
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = sdk.initializeApp(firebaseConfig);
                const fs = sdk.getFirestore(app);

                const dataRef = sdk.doc(fs, 'artifacts', appId, 'users', user.uid, 'data', 'user_archive');
                const unsubscribe = sdk.onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        if (cloudData.db) setDb(cloudData.db);
                        if (cloudData.mistakes) setMistakes(cloudData.mistakes);
                    }
                }, (error) => console.error("Firestore Sync Error:", error));

                return () => unsubscribe();
            }, [user]);

            const saveToCloud = async (updatedDb, updatedMistakes) => {
                if (!user || !window.FirebaseSDK) return;
                const sdk = window.FirebaseSDK;
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = sdk.initializeApp(firebaseConfig);
                const fs = sdk.getFirestore(app);

                const dataRef = sdk.doc(fs, 'artifacts', appId, 'users', user.uid, 'data', 'user_archive');
                try {
                    await sdk.setDoc(dataRef, {
                        db: updatedDb || db,
                        mistakes: updatedMistakes || mistakes,
                        updatedAt: Date.now()
                    }, { merge: true });
                } catch (e) {
                    console.error("Cloud Save Failed:", e);
                }
            };

            const parseData = async () => {
                if (!rawText.trim()) return;
                setIsParsing(true);
                setStatusMsg('æ­£åœ¨é€šè¿‡ AI ç¼–ç æ‚¨çš„èµ„æ–™... ðŸ•Šï¸');
                
                const systemPrompt = importType === 'question' 
                    ? `å°†æ–‡æœ¬è§£æžä¸ºè€ƒè¯•é¢˜ç›®JSONæ•°ç»„ã€‚å•é€‰: {type: 'single', question, options: [A, B, C, D], correct: ç´¢å¼•(0-3), logic} å¤šé€‰: {type: 'multiple', question, options: [A, B, C, D], correct: [ç´¢å¼•æ•°ç»„], logic} é—®ç­”: {type: 'open', question, correct: 'å‚è€ƒç­”æ¡ˆ', logic}`
                    : `å°†æ–‡æœ¬è§£æžä¸ºé—ªå¡JSONæ•°ç»„: [{front, back, logic}]ã€‚`;
                
                try {
                    const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `è§£æžä»¥ä¸‹${importType}å†…å®¹ï¼š\n${rawText}` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsed = JSON.parse(responseText || "[]");
                    const newItems = parsed.map(item => ({ ...item, id: Math.random().toString(36).substr(2, 9), status: null }));
                    
                    const updatedDb = {
                        ...db,
                        [activeSubject.id]: {
                            ...db[activeSubject.id],
                            [importType === 'question' ? 'questions' : 'cards']: [...(db[activeSubject.id][importType === 'question' ? 'questions' : 'cards'] || []), ...newItems]
                        }
                    };
                    
                    setDb(updatedDb);
                    await saveToCloud(updatedDb, mistakes);
                    setRawText('');
                    setStatusMsg('Edit Complete. æ¡£æ¡ˆå·²æ›´æ–°ã€‚');
                    setTimeout(() => setStatusMsg(''), 3000);
                    setView('home');
                } catch (e) { 
                    setStatusMsg('è§£ç å¤±è´¥ã€‚è¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚ðŸ’…');
                } finally { setIsParsing(false); }
            };

            const startSession = (mode, type) => {
                const subjectData = db[activeSubject.id] || { questions: [], cards: [] };
                let pool = type === 'cards' ? (subjectData.cards || []) : (subjectData.questions || []);
                if (!pool || pool.length === 0) return;
                
                if (mode === 'forgotten') pool = pool.filter(c => c.status === 'forgotten');
                if (mode === 'blurred') pool = pool.filter(c => c.status === 'blurred');
                if (pool.length === 0) return;

                const shuffled = [...pool].sort(() => Math.random() - 0.5);
                setActiveItems(shuffled);
                setCurrentIdx(0);
                setIsFlipped(false);
                setQuizAnswered(false);
                setSelectedIdx(shuffled[0].type === 'multiple' ? [] : null);
                setView(type);
            };

            const handleQuizAnswer = (idx) => {
                if (quizAnswered) return;
                const currentQ = activeItems[currentIdx];
                if (currentQ.type === 'multiple') {
                    setSelectedIdx(prev => {
                        const currentArr = Array.isArray(prev) ? prev : [];
                        return currentArr.includes(idx) ? currentArr.filter(i => i !== idx) : [...currentArr, idx];
                    });
                } else {
                    setSelectedIdx(idx);
                    finishQuestion(idx);
                }
            };

            const finishQuestion = async (finalSelection) => {
                const q = activeItems[currentIdx];
                setQuizAnswered(true);
                
                let isCorrect = false;
                if (q.type === 'multiple') {
                    isCorrect = JSON.stringify([...finalSelection].sort()) === JSON.stringify([...q.correct].sort());
                } else if (q.type === 'single') {
                    isCorrect = finalSelection === q.correct;
                }

                if (!isCorrect && q.type !== 'open') {
                    const newMistakes = mistakes.find(m => m.id === q.id) ? mistakes : [...mistakes, q];
                    setMistakes(newMistakes);
                    await saveToCloud(db, newMistakes);
                }
            };

            const updateCardStatus = async (status) => {
                const currentItem = activeItems[currentIdx];
                if (!currentItem) return;

                const updatedDb = {
                    ...db,
                    [activeSubject.id]: {
                        ...db[activeSubject.id],
                        cards: db[activeSubject.id].cards.map(c => c.id === currentItem.id ? { ...c, status } : c)
                    }
                };
                setDb(updatedDb);
                await saveToCloud(updatedDb, mistakes);
                goToNext();
            };

            const goToNext = () => {
                if (currentIdx + 1 < activeItems.length) {
                    const nextItem = activeItems[currentIdx + 1];
                    setCurrentIdx(c => c + 1);
                    setQuizAnswered(false);
                    setSelectedIdx(nextItem.type === 'multiple' ? [] : null);
                    setIsFlipped(false);
                } else {
                    setView('home');
                }
            };

            const removeFromArchive = async (id) => {
                const newMistakes = mistakes.filter(m => m.id !== id);
                setMistakes(newMistakes);
                await saveToCloud(db, newMistakes);
            };

            return (
                <div className="min-h-screen">
                    {/* High Fashion Background */}
                    <div className="fixed inset-0 pointer-events-none z-0">
                        <div className="absolute top-0 right-0 w-1/2 h-1/2 bg-gradient-to-bl from-gray-200/30 to-transparent blur-[120px]"></div>
                        <div className="absolute bottom-0 left-0 w-1/2 h-1/2 bg-gradient-to-tr from-[#D4C3B3]/10 to-transparent blur-[120px]"></div>
                    </div>

                    <nav className="relative z-10 flex justify-between items-center p-8 px-12 border-b border-gray-200 bg-white/40 backdrop-blur-xl">
                        <div className="flex items-center gap-6 cursor-pointer" onClick={() => setView('home')}>
                            <h1 className="text-2xl font-light tracking-[0.4em] uppercase border-b border-black pb-1">Archive</h1>
                            <span className="text-[10px] font-medium tracking-[0.2em] text-gray-400 mt-2 uppercase">Study Edit</span>
                        </div>
                        <button onClick={() => setView('burnbook')} className="text-[11px] font-bold tracking-widest uppercase hover:opacity-50 transition-opacity flex items-center gap-2">
                            The Archive ({mistakes.length})
                        </button>
                    </nav>

                    <main className="relative z-10 max-w-6xl mx-auto px-6 py-16">
                        {statusMsg && (
                            <div className="mb-8 p-4 bg-black text-white text-[10px] uppercase tracking-[0.3em] text-center animate-in shadow-xl">
                                {statusMsg}
                            </div>
                        )}

                        {!user && (
                            <div className="flex flex-col items-center justify-center py-40 text-gray-300">
                                <Icon name="sparkles" className="animate-spin mb-6" size={32} />
                                <span className="text-[10px] uppercase tracking-[0.6em]">Authenticating Private Archive...</span>
                            </div>
                        )}

                        {user && view === 'home' && (
                            <div className="space-y-24 animate-in">
                                <header className="space-y-6 text-center">
                                    <h2 className="text-7xl md:text-9xl font-light tracking-tighter leading-none italic font-serif text-gray-900">Effortless.</h2>
                                    <p className="text-xs font-bold uppercase tracking-[0.6em] text-gray-400">Master your craft with intention</p>
                                </header>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-12">
                                    {SUBJECTS.map((sub) => (
                                        <div key={sub.id} className="group relative space-y-8 p-4 transition-all hover:-translate-y-2">
                                            <div className={`aspect-[3/4] rounded-sm bg-gradient-to-br ${sub.color} shadow-2xl relative overflow-hidden flex flex-col justify-end p-8 text-white`}>
                                                <div className="absolute top-8 right-8 opacity-40"><Icon name={sub.icon} /></div>
                                                <div className="relative z-10 space-y-2">
                                                    <span className="text-[10px] font-bold tracking-[0.4em] opacity-60 uppercase">{sub.label}</span>
                                                    <h3 className="text-4xl font-light tracking-tight italic font-serif">{sub.name}</h3>
                                                </div>
                                            </div>
                                            <div className="space-y-6 px-2">
                                                <div className="flex justify-between text-[10px] font-bold tracking-widest text-gray-400 border-b border-gray-100 pb-2 uppercase">
                                                    <span>Archive Pool</span>
                                                    <span className="text-black font-medium">{(db[sub.id]?.questions || []).length + (db[sub.id]?.cards || []).length} Items</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <button onClick={() => { setActiveSubject(sub); startSession('all', 'questions'); }} className="py-4 bg-black text-white text-[10px] font-bold tracking-widest uppercase hover:bg-gray-800 transition shadow-lg">Practice</button>
                                                    <button onClick={() => { setActiveSubject(sub); setView('flash-options'); }} className="py-4 border border-black text-black text-[10px] font-bold tracking-widest uppercase hover:bg-black hover:text-white transition">Cards</button>
                                                </div>
                                                <button onClick={() => { setActiveSubject(sub); setView('input'); }} className="w-full text-[10px] font-bold tracking-widest text-gray-300 hover:text-black transition uppercase">+ Import Notes</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'flash-options' && (
                            <div className="max-w-xl mx-auto space-y-12 animate-in">
                                <button onClick={() => setView('home')} className="flex items-center gap-4 text-gray-400 font-bold uppercase text-[10px] tracking-widest hover:text-black"><Icon name="chevronLeft" size={16} /> Back</button>
                                <div className="bg-white p-12 border border-gray-100 shadow-sm space-y-10 text-center">
                                    <h2 className="text-3xl font-light italic font-serif text-gray-900">Focus Session</h2>
                                    <div className="space-y-4">
                                        {['all', 'forgotten', 'blurred'].map(mode => (
                                            <button key={mode} onClick={() => startSession(mode, 'cards')} className="w-full group flex justify-between items-center py-4 border-b border-gray-100 hover:border-black transition-all">
                                                <span className="text-[11px] font-bold tracking-[0.3em] uppercase">{mode} Signals</span>
                                                <span className="text-[10px] text-gray-300 group-hover:text-black">
                                                    {mode === 'all' ? (db[activeSubject.id]?.cards || []).length : (db[activeSubject.id]?.cards || []).filter(c => c.status === mode).length} Items
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'input' && (
                            <div className="max-w-4xl mx-auto animate-in">
                                <button onClick={() => setView('home')} className="mb-10 flex items-center gap-4 text-gray-400 font-bold uppercase text-[10px] tracking-widest hover:text-black"><Icon name="chevronLeft" size={16} /> Cancel</button>
                                <div className="bg-white p-12 border border-gray-100 shadow-sm space-y-12">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <span className="text-[10px] font-bold text-gray-300 uppercase tracking-widest">Workspace</span>
                                            <h2 className="text-4xl font-light italic font-serif text-gray-900">Import: {activeSubject.name}</h2>
                                        </div>
                                        <div className="flex border border-gray-100 p-1">
                                            {['question', 'card'].map(t => (
                                                <button key={t} onClick={() => setImportType(t)} className={`px-8 py-3 text-[10px] font-bold tracking-widest uppercase transition-all ${importType === t ? 'bg-black text-white shadow-md' : 'text-gray-300'}`}>{t}s</button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="p-6 bg-[#FAFAFA] border border-gray-100 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <span className="text-[9px] font-bold uppercase tracking-widest text-gray-400 font-medium">Recommended Structure</span>
                                            <button onClick={() => setRawText(TEMPLATES[importType])} className="text-[9px] font-bold uppercase border-b border-black text-black">Use Template</button>
                                        </div>
                                        <p className="text-[11px] text-gray-400 leading-relaxed italic">AI is decoding your archive. Keep data separate for best results.</p>
                                    </div>

                                    <textarea value={rawText} onChange={(e) => setRawText(e.target.value)} placeholder="Paste content here..." className="w-full h-80 bg-[#FAFAFA] border-none p-10 outline-none text-sm font-medium leading-relaxed resize-none shadow-inner placeholder:text-gray-200" />
                                    
                                    <button disabled={isParsing || !rawText} onClick={parseData} className="w-full py-6 bg-black text-white text-[11px] font-bold tracking-[0.4em] uppercase hover:bg-gray-800 disabled:opacity-20 transition-all flex items-center justify-center gap-4 shadow-xl">
                                        {isParsing ? <Icon name="sparkles" className="animate-spin" /> : <Icon name="sparkles" />} {isParsing ? 'Archiving' : 'Generate Edit'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === 'questions' && activeItems.length > 0 && (
                            <div className="max-w-3xl mx-auto animate-in">
                                <div className="flex justify-between items-end mb-12">
                                    <span className="text-[10px] font-bold uppercase tracking-[0.5em] text-gray-300 font-medium">Section {currentIdx + 1} // {activeItems.length}</span>
                                    <button onClick={() => setView('home')} className="text-[10px] font-bold uppercase text-gray-300 hover:text-black tracking-widest font-bold">Quit</button>
                                </div>
                                <div className="bg-white border border-gray-100 p-12 md:p-20 space-y-16 shadow-lg relative">
                                    <div className="absolute top-0 left-0 h-1 bg-black transition-all duration-700" style={{ width: `${((currentIdx+1)/activeItems.length)*100}%` }}></div>
                                    {activeItems[currentIdx] && (
                                        <React.Fragment>
                                            <div className="flex justify-between items-start gap-4">
                                                <p className="text-4xl font-light italic font-serif leading-tight text-gray-900">{activeItems[currentIdx].question}</p>
                                                {activeItems[currentIdx].type === 'multiple' && (
                                                    <span className="shrink-0 text-[9px] font-bold uppercase tracking-widest px-2 py-1 bg-gray-100 text-gray-500 rounded-sm">Multiple</span>
                                                )}
                                            </div>
                                            
                                            <div className="space-y-4">
                                                {activeItems[currentIdx].type !== 'open' ? (
                                                    (activeItems[currentIdx].options || []).map((opt, i) => {
                                                        const isCorrect = Array.isArray(activeItems[currentIdx].correct) 
                                                            ? activeItems[currentIdx].correct.includes(i)
                                                            : i === activeItems[currentIdx].correct;
                                                        const isSelected = Array.isArray(selectedIdx) 
                                                            ? selectedIdx.includes(i)
                                                            : selectedIdx === i;
                                                        let style = "border-gray-50 bg-[#FAFAFA] hover:bg-gray-100";
                                                        if (quizAnswered) {
                                                            if (isCorrect) style = "border-black bg-black text-white shadow-md";
                                                            else if (isSelected) style = "border-gray-200 bg-gray-50 text-gray-300";
                                                            else style = "opacity-20";
                                                        } else if (isSelected) style = "border-black bg-gray-100";

                                                        return (
                                                            <button key={i} disabled={quizAnswered} onClick={() => handleQuizAnswer(i)} className={`w-full text-left p-6 border text-sm font-medium transition-all flex justify-between items-center ${style}`}>
                                                                <span className="flex items-center gap-4">
                                                                    {activeItems[currentIdx].type === 'multiple' && (
                                                                        <Icon name={isSelected ? "check" : "square"} size={14} className={isSelected ? "text-black" : "text-gray-200"} />
                                                                    )}
                                                                    {opt}
                                                                </span>
                                                                {quizAnswered && isCorrect && <Icon name="check" size={16} />}
                                                            </button>
                                                        )
                                                    })
                                                ) : (
                                                    <div className="space-y-8">
                                                        {!quizAnswered ? (
                                                            <button onClick={() => setQuizAnswered(true)} className="w-full py-20 border border-dashed border-gray-200 text-gray-300 font-bold uppercase tracking-[0.3em] hover:text-black transition-all flex flex-col items-center gap-4 group"><Icon name="eye" size={24} className="group-hover:scale-110 transition-transform" /> Reveal</button>
                                                        ) : (
                                                            <div className="p-10 bg-[#FAFAFA] border border-gray-100 shadow-inner text-gray-600 italic font-serif text-lg leading-relaxed">
                                                                {activeItems[currentIdx].correct}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            {activeItems[currentIdx].type === 'multiple' && !quizAnswered && (
                                                <button onClick={() => finishQuestion(selectedIdx)} disabled={selectedIdx.length === 0} className="w-full py-6 bg-black text-white text-[11px] font-bold tracking-[0.4em] uppercase hover:bg-gray-800 disabled:opacity-20 transition shadow-xl">Submit Archive</button>
                                            )}

                                            {quizAnswered && (
                                                <div className="pt-12 border-t border-gray-50 space-y-10 animate-in">
                                                    <div className="text-[11px] leading-loose text-gray-400 italic">"Edit Note: {activeItems[currentIdx].logic}"</div>
                                                    <button onClick={goToNext} className="w-full py-6 bg-black text-white text-[11px] font-bold tracking-[0.4em] uppercase hover:bg-gray-800 transition flex items-center justify-center gap-4 shadow-xl">Next Look <Icon name="arrowRight" size={16}/></button>
                                                </div>
                                            )}
                                        </React.Fragment>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'cards' && activeItems.length > 0 && (
                            <div className="max-w-2xl mx-auto animate-in">
                                <div className="flex justify-between items-center mb-10">
                                    <span className="text-[10px] font-bold uppercase tracking-[0.5em] text-gray-300 font-medium font-bold">Session {currentIdx + 1} // {activeItems.length}</span>
                                    <button onClick={() => setView('home')} className="text-[10px] text-gray-300 hover:text-black uppercase font-bold tracking-widest transition">Close</button>
                                </div>
                                <div className="perspective-1000">
                                    {activeItems[currentIdx] && (
                                        <div onClick={() => setIsFlipped(!isFlipped)} className={`relative h-[550px] w-full transition-all duration-1000 preserve-3d cursor-pointer ${isFlipped ? 'rotate-y-180' : ''}`}>
                                            <div className="absolute inset-0 backface-hidden bg-white border border-gray-100 shadow-xl p-16 flex flex-col items-center justify-center text-center">
                                                <div className="absolute top-12 left-1/2 -translate-x-1/2"><Icon name="circle" size={12} className="text-gray-100 animate-pulse" /></div>
                                                <p className="text-3xl font-light italic font-serif text-gray-900 leading-snug">{activeItems[currentIdx].front}</p>
                                                <span className="absolute bottom-16 font-bold text-[9px] text-gray-200 tracking-[0.5em] uppercase">Reveal Detail</span>
                                            </div>
                                            <div className="absolute inset-0 backface-hidden rotate-y-180 bg-black border border-black p-16 flex flex-col items-center justify-center text-center shadow-2xl">
                                                <p className="text-4xl font-light italic font-serif text-white leading-tight mb-10">{activeItems[currentIdx].back}</p>
                                                <p className="text-[11px] text-gray-500 leading-loose italic max-w-sm">"{activeItems[currentIdx].logic}"</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className={`mt-16 flex gap-6 transition-all duration-1000 ${isFlipped ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-10 scale-95 pointer-events-none'}`}>
                                    <button onClick={() => updateCardStatus('forgotten')} className="flex-1 py-5 border border-gray-100 text-[10px] font-bold tracking-[0.3em] uppercase hover:bg-black hover:text-white transition">Forgotten</button>
                                    <button onClick={() => updateCardStatus('blurred')} className="flex-1 py-5 border border-gray-100 text-[10px] font-bold tracking-[0.3em] uppercase hover:bg-black hover:text-white transition">Blurred</button>
                                    <button onClick={() => updateCardStatus('mastered')} className="flex-1 py-5 bg-black text-white text-[10px] font-bold tracking-[0.3em] uppercase transition">Mastered</button>
                                </div>
                            </div>
                        )}

                        {view === 'burnbook' && (
                            <div className="max-w-5xl mx-auto animate-in">
                                <header className="flex justify-between items-end mb-20 border-b border-gray-200 pb-10">
                                    <h2 className="text-6xl font-light italic font-serif text-gray-900">The Archive</h2>
                                    <button onClick={() => setView('home')} className="text-[10px] font-bold uppercase tracking-[0.4em] hover:opacity-50 transition tracking-widest">Return</button>
                                </header>
                                {mistakes.length === 0 ? (
                                    <div className="text-center py-40 border border-dashed border-gray-100 text-gray-200 uppercase tracking-[0.6em] font-medium">Clean Archive // Zero Distortions</div>
                                ) : (
                                    <div className="grid gap-12">
                                        {(mistakes || []).map((m, i) => (
                                            <div key={m.id || i} className="bg-white border border-gray-50 p-12 hover:shadow-xl group transition-all relative overflow-hidden">
                                                <div className="flex justify-between mb-8 relative z-10">
                                                    <span className="text-[9px] font-bold tracking-[0.5em] text-gray-300 uppercase font-medium">Archive Entry {i+1}</span>
                                                    <button onClick={() => removeFromArchive(m.id)} className="text-gray-200 hover:text-black transition"><Icon name="trash" size={16} /></button>
                                                </div>
                                                <p className="text-3xl font-light italic font-serif text-gray-900 mb-10 relative z-10 leading-tight pr-10">{m.question}</p>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-10 relative z-10">
                                                    <div className="space-y-4 border-l border-black pl-6">
                                                        <span className="text-[9px] font-bold text-gray-300 uppercase tracking-widest block font-medium">Detail</span>
                                                        <p className="text-lg font-medium text-gray-700 italic leading-relaxed">
                                                            {m.type === 'open' ? m.correct : (Array.isArray(m.correct) ? m.correct.map(idx => (m.options && m.options[idx]) || 'N/A').join(', ') : (m.options && m.options[m.correct] !== undefined ? m.options[m.correct] : 'N/A'))}
                                                        </p>
                                                    </div>
                                                    <div className="space-y-4 text-[11px] text-gray-400 italic font-medium leading-relaxed">
                                                        <span className="text-[9px] font-bold text-gray-300 uppercase tracking-widest block not-italic">Perspective</span>
                                                        <p>"{m.logic}"</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
