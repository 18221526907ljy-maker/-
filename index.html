<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gossip Study: The Hailey Edit</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts: Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        .font-serif { font-family: 'Playfair Display', serif; }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F5F5F7; }
        ::-webkit-scrollbar-thumb { background: #D1D1D1; }
        ::-webkit-scrollbar-thumb:hover { background: #8E8E93; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeIn 0.9s ease-out forwards;
        }

        /* High Fashion Comfort Typography */
        .question-text { font-size: 3rem; line-height: 1.2; font-weight: 300; }
        .body-text { font-size: 1.25rem; line-height: 1.8; }
        .small-caps { font-variant: small-caps; letter-spacing: 0.2em; }
    </style>
</head>
<body class="bg-[#F5F5F7] text-[#1D1D1F] font-sans selection:bg-[#E5E5E5] overflow-x-hidden">
    <div id="root"></div>

    <!-- Firebase Bridge - Public Access Mode -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, getDoc, onSnapshot, collection
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                plus: <path d="M12 5v14M5 12h14" />,
                play: <path d="m5 3 14 9-14 9V3z" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                chevronLeft: <path d="m15 18-6-6 6-6" />,
                check: <path d="M20 6 9 17l-5-5" />,
                sparkles: <path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z" />,
                eye: (
                    <React.Fragment>
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
                    </React.Fragment>
                ),
                layers: (
                    <React.Fragment>
                        <path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/>
                        <path d="m2.6 10.33 8.58 3.9a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0 1.83l-8.58 3.91a2 2 0 0 1-1.66 0l-8.58-3.9a1 1 0 0 1 0-1.83Z"/>
                        <path d="m2.6 14.58 8.58 3.9a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0 1.83l-8.58 3.91a2 2 0 0 1-1.66 0l-8.58-3.9a1 1 0 0 1 0-1.83Z"/>
                    </React.Fragment>
                ),
                globe: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20M2 12h20" />
                    </React.Fragment>
                ),
                wallet: (
                    <React.Fragment>
                        <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/>
                        <path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4" />
                    </React.Fragment>
                ),
                arrowRight: <path d="M5 12h14m-7-7 7 7-7 7" />,
                circle: <circle cx="12" cy="12" r="10" />,
                square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
                newspaper: <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2M18 14h-8M15 18h-5M10 6h8v4h-8V6Z" />,
                edit: (
                    <React.Fragment>
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </React.Fragment>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const apiKey = ""; 

        const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw error;
            }
        };

        const SUBJECTS = [
            { id: 'brand', name: 'å“ç‰Œç®¡ç†', label: 'THE LABEL', color: 'from-[#2D2D2D] to-[#1A1A1A]', icon: 'layers', chapters: 10 },
            { id: 'marketing', name: 'è¥é”€æ¸ é“', label: 'DISTRIBUTION', color: 'from-[#8E8E93] to-[#636366]', icon: 'globe', chapters: 8 },
            { id: 'finance', name: 'è´¢åŠ¡ç®¡ç†', label: 'CAPITAL', color: 'from-[#D4C3B3] to-[#A08E7D]', icon: 'wallet', chapters: 12 }
        ];

        const TEMPLATES = {
            question: "é¢˜ç›®ï¼š[å¤šé€‰] å“ç‰Œå®šä½çš„æ ¸å¿ƒè¦ç´ æœ‰å“ªäº›ï¼Ÿ\nA. ç›®æ ‡å—ä¼—\nB. å“ç‰Œç†å¿µ\nC. ç«žäº‰å·®å¼‚\nD. è¥é”€é¢„ç®—\nç­”æ¡ˆï¼šABC\nè§£æžï¼šé¢„ç®—å±žäºŽæ‰§è¡Œå±‚é¢è€Œéžå®šä½æ ¸å¿ƒã€‚",
            card: "æ­£é¢ï¼šHailey Bieber Style\nèƒŒé¢ï¼šMinimalist, sophisticated, and clean.\nè§£æžï¼šIt's all about that quiet luxury."
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); 
            const [activeSubject, setActiveSubject] = useState(SUBJECTS[0]);
            const [db, setDb] = useState({ brand: { questions: [], cards: [] }, marketing: { questions: [], cards: [] }, finance: { questions: [], cards: [] } });
            const [mistakes, setMistakes] = useState([]);
            const [activeItems, setActiveItems] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [quizAnswered, setQuizAnswered] = useState(false);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [rawText, setRawText] = useState('');
            const [isParsing, setIsParsing] = useState(false);
            const [importType, setImportType] = useState('question');
            const [statusMsg, setStatusMsg] = useState('');
            
            const [activeChapter, setActiveChapter] = useState(1);
            const [sessionTargetType, setSessionTargetType] = useState('questions'); 

            const [aiSummary, setAiSummary] = useState(null);
            const [isGeneratingAi, setIsGeneratingAi] = useState(false);
            const [expertInsight, setExpertInsight] = useState(null);

            const [manualMistake, setManualMistake] = useState({ question: '', correct: '', logic: '' });

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'gossip-study-hailey';

            // --- Authentication Setup (Rule 3 - FIRST) ---
            useEffect(() => {
                let sdkInited = false;
                const checkAndInit = async () => {
                    if (window.FirebaseSDK && !sdkInited) {
                        sdkInited = true;
                        const sdk = window.FirebaseSDK;
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = sdk.initializeApp(firebaseConfig);
                        const auth = sdk.getAuth(app);

                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await sdk.signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await sdk.signInAnonymously(auth);
                            }
                            
                            sdk.onAuthStateChanged(auth, (u) => {
                                if (u) setUser(u);
                            });
                        } catch (err) {
                            console.error("Auth failed:", err);
                        }
                    }
                };

                const interval = setInterval(() => {
                    if (window.FirebaseSDK) {
                        checkAndInit();
                        clearInterval(interval);
                    }
                }, 200);

                return () => clearInterval(interval);
            }, []);

            // --- Real-time Cloud Sync (Rule 1 Path Fix) ---
            useEffect(() => {
                if (!user || !window.FirebaseSDK) return;
                const sdk = window.FirebaseSDK;
                const fs = sdk.getFirestore();

                // Path Fix: Ensure 6 segments for document reference
                const dataRef = sdk.doc(fs, 'artifacts', appId, 'public', 'data', 'archives', 'global_archive');
                
                const unsubscribe = sdk.onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        if (cloudData.db) setDb(cloudData.db);
                        if (cloudData.mistakes) setMistakes(cloudData.mistakes);
                    }
                }, (error) => {
                    console.error("Firestore Sync Error:", error);
                    if (error.code === 'permission-denied') {
                        setStatusMsg("Connecting to global archive... ðŸ•Šï¸");
                    }
                });

                return () => unsubscribe();
            }, [user]);

            const saveToCloud = async (updatedDb, updatedMistakes) => {
                if (!user || !window.FirebaseSDK) return;
                const sdk = window.FirebaseSDK;
                const fs = sdk.getFirestore();

                const dataRef = sdk.doc(fs, 'artifacts', appId, 'public', 'data', 'archives', 'global_archive');
                try {
                    await sdk.setDoc(dataRef, {
                        db: updatedDb || db,
                        mistakes: updatedMistakes || mistakes,
                        updatedAt: Date.now()
                    }, { merge: true });
                } catch (e) {
                    console.error("Cloud Save Failed:", e);
                }
            };

            const parseData = async () => {
                if (!rawText.trim()) return;
                setIsParsing(true);
                setStatusMsg('æ­£åœ¨é€šè¿‡ AI ç¼–ç æ‚¨çš„èµ„æ–™... ðŸ•Šï¸');
                
                const systemPrompt = importType === 'question' 
                    ? `å°†æ–‡æœ¬è§£æžä¸ºè€ƒè¯•é¢˜ç›®JSONæ•°ç»„ã€‚å•é€‰: {type: 'single', question, options: [A, B, C, D], correct: ç´¢å¼•(0-3), logic} å¤šé€‰: {type: 'multiple', question, options: [A, B, C, D], correct: [ç´¢å¼•æ•°ç»„], logic} é—®ç­”: {type: 'open', question, correct: 'å‚è€ƒç­”æ¡ˆ', logic}`
                    : `å°†æ–‡æœ¬è§£æžä¸ºé—ªå¡JSONæ•°ç»„: [{front, back, logic}]ã€‚`;
                
                try {
                    const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `è§£æžä»¥ä¸‹${importType}å†…å®¹ï¼š\n${rawText}` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsed = JSON.parse(responseText || "[]");
                    const newItems = parsed.map(item => ({ ...item, id: Math.random().toString(36).substr(2, 9), status: null, chapter: activeChapter }));
                    
                    const updatedDb = {
                        ...db,
                        [activeSubject.id]: {
                            ...db[activeSubject.id],
                            [importType === 'question' ? 'questions' : 'cards']: [...(db[activeSubject.id][importType === 'question' ? 'questions' : 'cards'] || []), ...newItems]
                        }
                    };
                    
                    setDb(updatedDb);
                    await saveToCloud(updatedDb, mistakes);
                    setRawText('');
                    setStatusMsg('Edit Complete. å…±äº«æ¡£æ¡ˆå·²æ›´æ–°ã€‚');
                    setTimeout(() => setStatusMsg(''), 3000);
                    setView('home');
                } catch (e) { 
                    setStatusMsg('è§£ç å¤±è´¥ã€‚è¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚ðŸ’…');
                } finally { setIsParsing(false); }
            };

            const startSession = (mode, type, chapterFilter = 'all') => {
                const subjectData = db[activeSubject.id] || { questions: [], cards: [] };
                let pool = type === 'cards' ? (subjectData.cards || []) : (subjectData.questions || []);
                
                if (chapterFilter === 'mock') {
                    pool = [...pool].sort(() => Math.random() - 0.5).slice(0, 15);
                } else if (chapterFilter !== 'all') {
                    pool = pool.filter(item => item.chapter === parseInt(chapterFilter));
                }

                if (!pool || pool.length === 0) {
                    setStatusMsg('No content found for this selection. ðŸ•Šï¸');
                    setTimeout(() => setStatusMsg(''), 2000);
                    return;
                }
                if (mode === 'forgotten') pool = pool.filter(c => c.status === 'forgotten');
                if (mode === 'blurred') pool = pool.filter(c => c.status === 'blurred');

                const shuffled = [...pool].sort(() => Math.random() - 0.5);
                setActiveItems(shuffled);
                setCurrentIdx(0);
                setIsFlipped(false);
                setQuizAnswered(false);
                setSelectedIdx(shuffled[0].type === 'multiple' ? [] : null);
                setExpertInsight(null);
                setView(type === 'cards' ? 'cards' : 'questions');
            };

            const handleQuizAnswer = (idx) => {
                if (quizAnswered) return;
                const currentQ = activeItems[currentIdx];
                if (currentQ.type === 'multiple') {
                    setSelectedIdx(prev => {
                        const currentArr = Array.isArray(prev) ? prev : [];
                        return currentArr.includes(idx) ? currentArr.filter(i => i !== idx) : [...currentArr, idx];
                    });
                } else {
                    setSelectedIdx(idx);
                    finishQuestion(idx);
                }
            };

            const finishQuestion = async (finalSelection) => {
                const q = activeItems[currentIdx];
                setQuizAnswered(true);
                
                let isCorrect = false;
                if (q.type === 'multiple') {
                    isCorrect = JSON.stringify([...finalSelection].sort()) === JSON.stringify([...q.correct].sort());
                } else if (q.type === 'single') {
                    isCorrect = finalSelection === q.correct;
                }

                if (!isCorrect && q.type !== 'open') {
                    const newMistakes = mistakes.find(m => m.id === q.id) ? mistakes : [...mistakes, q];
                    setMistakes(newMistakes);
                    await saveToCloud(db, newMistakes);
                }
            };

            const updateCardStatus = async (status) => {
                const currentItem = activeItems[currentIdx];
                if (!currentItem) return;

                const updatedDb = {
                    ...db,
                    [activeSubject.id]: {
                        ...db[activeSubject.id],
                        cards: db[activeSubject.id].cards.map(c => c.id === currentItem.id ? { ...c, status } : c)
                    }
                };
                setDb(updatedDb);
                await saveToCloud(updatedDb, mistakes);
                goToNext();
            };

            const goToNext = () => {
                if (currentIdx + 1 < activeItems.length) {
                    const nextItem = activeItems[currentIdx + 1];
                    setCurrentIdx(c => c + 1);
                    setQuizAnswered(false);
                    setSelectedIdx(nextItem.type === 'multiple' ? [] : null);
                    setIsFlipped(false);
                    setExpertInsight(null);
                } else {
                    setView('home');
                }
            };

            const addManualMistake = async () => {
                if (!manualMistake.question || !manualMistake.correct) return;
                const newM = { ...manualMistake, id: 'm-' + Date.now(), type: 'open', logic: manualMistake.logic, subjectId: activeSubject.id };
                const newMistakes = [...mistakes, newM];
                setMistakes(newMistakes);
                await saveToCloud(db, newMistakes);
                setManualMistake({ question: '', correct: '', logic: '' });
                setView('burnbook');
            };

            const generateSubjectSummary = async (subjectId) => {
                const subject = SUBJECTS.find(s => s.id === subjectId);
                const items = db[subjectId]?.questions || [];
                if (items.length === 0) return;
                
                setIsGeneratingAi(true);
                setView('ai-summary');
                try {
                    const itemsText = items.map(i => i.question).join('\n');
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `ä½œä¸ºé¡¶çº§æ—¶å°šè¯„è®ºå®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹${subject.name}ç§‘ç›®çš„é¢˜ç›®åˆ—è¡¨ç”Ÿæˆä¸€ä»½æžç®€æ€»ç»“ã€‚é¢˜ç›®åˆ—è¡¨:\n${itemsText}` }] }]
                        })
                    });
                    const result = await response.json();
                    setAiSummary(result.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { console.error(e); } finally { setIsGeneratingAi(false); }
            };

            const generateExpertInsight = async (questionData) => {
                setIsGeneratingAi(true); setExpertInsight(null);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `ä¸ºæœ¬é¢˜æä¾›ä¸€æ®µæžç®€è¡Œä¸šä¸“å®¶åˆ†æžï¼ˆ150å­—å†…ï¼ŒHaileyé£Žï¼‰ã€‚é¢˜ç›®:${questionData.question}` }] }]
                        })
                    });
                    const result = await response.json();
                    setExpertInsight(result.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { console.error(e); } finally { setIsGeneratingAi(false); }
            };

            const removeFromArchive = async (id) => {
                const newMistakes = mistakes.filter(m => m.id !== id);
                setMistakes(newMistakes);
                await saveToCloud(db, newMistakes);
            };

            return (
                <div className="min-h-screen">
                    <div className="fixed inset-0 pointer-events-none z-0">
                        <div className="absolute top-0 right-0 w-2/3 h-2/3 bg-gradient-to-bl from-gray-200/20 to-transparent blur-[120px]"></div>
                        <div className="absolute bottom-0 left-0 w-2/3 h-2/3 bg-gradient-to-tr from-[#D4C3B3]/10 to-transparent blur-[120px]"></div>
                    </div>

                    <nav className="relative z-10 flex justify-between items-center p-10 px-16 border-b border-gray-200 bg-white/40 backdrop-blur-xl">
                        <div className="flex items-center gap-10 cursor-pointer" onClick={() => setView('home')}>
                            <h1 className="text-3xl font-light tracking-[0.5em] uppercase border-b border-black pb-2 text-gray-900">Archive</h1>
                            <span className="text-xs font-bold tracking-[0.3em] text-gray-400 mt-2 uppercase">The Global Edit</span>
                        </div>
                        <button onClick={() => setView('burnbook')} className="text-xs font-bold tracking-widest uppercase hover:opacity-50 transition-opacity flex items-center gap-3">
                            The Archive ({mistakes.length})
                        </button>
                    </nav>

                    <main className="relative z-10 max-w-7xl mx-auto px-8 py-20">
                        {statusMsg && (
                            <div className="mb-12 p-5 bg-black text-white text-xs uppercase tracking-[0.4em] text-center animate-in shadow-2xl">
                                {statusMsg}
                            </div>
                        )}

                        {!user && (
                            <div className="flex flex-col items-center justify-center py-40 text-gray-300">
                                <Icon name="sparkles" className="animate-spin mb-8" size={40} />
                                <span className="text-xs uppercase tracking-[0.8em]">Opening Shared Portal...</span>
                            </div>
                        )}

                        {user && view === 'home' && (
                            <div className="space-y-32 animate-in">
                                <header className="space-y-10 text-center">
                                    <h2 className="text-8xl md:text-[10rem] font-light tracking-tighter leading-none italic font-serif text-gray-900">Effortless.</h2>
                                    <p className="text-sm font-bold uppercase tracking-[0.8em] text-gray-400">Collaborative Masterpiece</p>
                                </header>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-16">
                                    {SUBJECTS.map((sub) => (
                                        <div key={sub.id} className="group relative space-y-12 p-2 transition-all hover:-translate-y-3">
                                            <div className={`aspect-[3/4] rounded-sm bg-gradient-to-br ${sub.color} shadow-[30px_30px_60px_rgba(0,0,0,0.1)] relative overflow-hidden flex flex-col justify-end p-10 text-white`}>
                                                <div className="absolute top-10 right-10 opacity-30"><Icon name={sub.icon} size={30} /></div>
                                                <div className="relative z-10 space-y-3 text-white">
                                                    <span className="text-xs font-bold tracking-[0.5em] opacity-60 uppercase">{sub.label}</span>
                                                    <h3 className="text-5xl font-light tracking-tight italic font-serif leading-tight">{sub.name}</h3>
                                                    <div className="text-[10px] font-bold tracking-[0.3em] opacity-40 uppercase pt-4">{sub.chapters} CHAPTERS</div>
                                                </div>
                                            </div>
                                            <div className="space-y-8 px-4">
                                                <div className="grid grid-cols-2 gap-6">
                                                    <button onClick={() => { setActiveSubject(sub); setSessionTargetType('questions'); setView('chapter-select'); }} className="py-6 bg-black text-white text-xs font-bold tracking-widest uppercase hover:bg-gray-800 transition shadow-xl">Practice</button>
                                                    <button onClick={() => { setActiveSubject(sub); setSessionTargetType('cards'); setView('chapter-select'); }} className="py-6 border border-black text-black text-xs font-bold tracking-widest uppercase hover:bg-black hover:text-white transition">Cards</button>
                                                </div>
                                                <button onClick={() => { setActiveSubject(sub); startSession('all', 'questions', 'mock'); }} className="w-full py-5 bg-stone-100 text-stone-600 text-[10px] font-bold tracking-[0.5em] uppercase hover:bg-black hover:text-white transition">âœ¨ Mock Exam</button>
                                                <div className="flex justify-between items-center pt-2">
                                                    <button onClick={() => { setActiveSubject(sub); setView('input'); }} className="text-[10px] font-bold tracking-widest text-gray-400 hover:text-black transition uppercase">Import</button>
                                                    <button onClick={() => generateSubjectSummary(sub.id)} className="text-[10px] font-bold tracking-widest text-stone-300 hover:text-stone-900 transition uppercase">âœ¨ Summary</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'chapter-select' && (
                            <div className="max-w-4xl mx-auto space-y-16 animate-in">
                                <button onClick={() => setView('home')} className="flex items-center gap-6 text-gray-400 font-bold uppercase text-xs tracking-widest transition hover:text-black"><Icon name="chevronLeft" size={20} /> Back to Library</button>
                                <div className="bg-white p-16 md:p-24 border border-gray-100 shadow-sm space-y-16">
                                    <div className="space-y-4">
                                        <span className="text-xs font-bold text-gray-300 uppercase tracking-widest">{activeSubject.name}</span>
                                        <h2 className="text-6xl font-light italic font-serif text-gray-900">The Segments</h2>
                                    </div>
                                    <div className="grid grid-cols-1 gap-12">
                                        <button onClick={() => startSession('all', sessionTargetType, 'all')} className="w-full py-10 border border-gray-100 text-xs font-bold tracking-[0.5em] uppercase hover:bg-black hover:text-white transition font-bold text-center">Entire Anthology</button>
                                        <div className="space-y-8">
                                            <span className="text-[10px] font-bold text-gray-300 uppercase tracking-[0.3em] block border-b border-gray-50 pb-4 text-center">Chapter Selection</span>
                                            <div className="grid grid-cols-5 md:grid-cols-6 gap-5">
                                                {Array.from({ length: activeSubject.chapters }).map((_, i) => (
                                                    <button key={i} onClick={() => startSession('all', sessionTargetType, (i + 1).toString())} className="aspect-square border border-gray-100 flex items-center justify-center text-sm font-bold hover:bg-black hover:text-white transition">
                                                        {i + 1}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'ai-summary' && (
                            <div className="max-w-3xl mx-auto space-y-12 animate-in">
                                <button onClick={() => setView('home')} className="flex items-center gap-6 text-gray-400 font-bold uppercase text-xs tracking-widest transition hover:text-black"><Icon name="chevronLeft" size={20} /> Back</button>
                                <div className="bg-white p-16 md:p-24 border border-gray-100 shadow-sm space-y-10 relative text-center">
                                    {isGeneratingAi ? (
                                        <div className="flex flex-col items-center py-20 text-stone-300 gap-4">
                                            <Icon name="sparkles" className="animate-spin" />
                                            <span className="text-[10px] uppercase tracking-[0.4em]">Curating Editorial...</span>
                                        </div>
                                    ) : (
                                        <div className="prose prose-stone max-w-none">
                                            <Icon name="newspaper" className="mx-auto mb-10 text-stone-200" size={40} />
                                            <div className="font-serif italic text-gray-900 leading-relaxed text-2xl" dangerouslySetInnerHTML={{ __html: aiSummary?.replace(/\n/g, '<br/>') }} />
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'input' && (
                            <div className="max-w-4xl mx-auto animate-in">
                                <button onClick={() => setView('home')} className="mb-12 flex items-center gap-6 text-gray-400 font-bold uppercase text-xs tracking-widest hover:text-black"><Icon name="chevronLeft" size={20} /> Abort</button>
                                <div className="bg-white p-16 border border-gray-100 shadow-sm space-y-16">
                                    <div className="flex justify-between items-end">
                                        <div className="space-y-2">
                                            <span className="text-xs font-bold text-gray-300 uppercase tracking-widest">Global Entry</span>
                                            <h2 className="text-5xl font-light italic font-serif text-gray-900 leading-tight pr-10">Add: {activeSubject.name}</h2>
                                        </div>
                                        <div className="flex border border-gray-100 p-1">
                                            {['question', 'card'].map(t => (
                                                <button key={t} onClick={() => setImportType(t)} className={`px-10 py-4 text-xs font-bold tracking-widest uppercase transition-all ${importType === t ? 'bg-black text-white shadow-xl' : 'text-gray-300'}`}>{t}s</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        <span className="text-[10px] font-bold text-gray-300 uppercase tracking-widest">Assign to Chapter</span>
                                        <div className="flex flex-wrap gap-3">
                                            {Array.from({ length: activeSubject.chapters }).map((_, i) => (
                                                <button key={i} onClick={() => setActiveChapter(i + 1)} className={`px-5 py-3 text-[10px] font-bold border transition-all ${activeChapter === i + 1 ? 'bg-black text-white border-black' : 'border-gray-100 text-gray-400'}`}>Ch. {i + 1}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <textarea value={rawText} onChange={(e) => setRawText(e.target.value)} placeholder="Paste shared knowledge here..." className="w-full h-[500px] bg-[#FAFAFA] border-none p-12 outline-none text-base font-medium leading-relaxed resize-none shadow-inner placeholder:text-gray-200" />
                                    <button disabled={isParsing || !rawText} onClick={parseData} className="w-full py-8 bg-black text-white text-xs font-bold tracking-[0.5em] uppercase hover:bg-gray-800 transition-all flex items-center justify-center gap-6 shadow-2xl font-bold">
                                        {isParsing ? <Icon name="sparkles" className="animate-spin" /> : <Icon name="sparkles" />} Decode Intel
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === 'questions' && activeItems.length > 0 && (
                            <div className="max-w-5xl mx-auto animate-in">
                                <div className="flex justify-between items-end mb-16 relative">
                                    <div className="flex flex-col gap-2">
                                        <span className="text-xs font-bold uppercase tracking-[0.6em] text-gray-300">Look {currentIdx + 1} / {activeItems.length}</span>
                                        <span className="text-xs font-bold text-stone-300 uppercase tracking-[0.2em] italic">Chapter {activeItems[currentIdx].chapter || 'Mock'}</span>
                                    </div>
                                    <button onClick={() => setView('home')} className="text-xs text-gray-300 hover:text-black uppercase font-bold tracking-widest transition">Terminate</button>
                                </div>
                                <div className="bg-white border border-gray-100 p-20 md:p-28 space-y-20 shadow-2xl relative">
                                    <div className="absolute top-0 left-0 h-1.5 bg-black transition-all duration-1000" style={{ width: `${((currentIdx+1)/activeItems.length)*100}%` }}></div>
                                    <p className="question-text italic font-serif text-gray-900 leading-tight">{activeItems[currentIdx].question}</p>
                                    
                                    <div className="space-y-6">
                                        {activeItems[currentIdx].type !== 'open' ? (
                                            (activeItems[currentIdx].options || []).map((opt, i) => {
                                                const isCorrect = Array.isArray(activeItems[currentIdx].correct) ? activeItems[currentIdx].correct.includes(i) : i === activeItems[currentIdx].correct;
                                                const isSel = Array.isArray(selectedIdx) ? selectedIdx.includes(i) : selectedIdx === i;
                                                let style = "border-gray-50 bg-[#FAFAFA] hover:bg-gray-100";
                                                if (quizAnswered) {
                                                    if (isCorrect) style = "border-black bg-black text-white shadow-2xl scale-[1.02]";
                                                    else if (isSel) style = "border-gray-200 bg-gray-50 text-gray-300 scale-[0.98]";
                                                    else style = "opacity-10";
                                                } else if (isSel) style = "border-black bg-gray-100";

                                                return (
                                                    <button key={i} disabled={quizAnswered} onClick={() => handleQuizAnswer(i)} className={`w-full text-left p-10 border body-text font-medium transition-all flex justify-between items-center ${style}`}>
                                                        <span className="flex items-center gap-8">
                                                            {activeItems[currentIdx].type === 'multiple' && <Icon name={isSel ? "check" : "square"} size={18} />}
                                                            {opt}
                                                        </span>
                                                        {quizAnswered && isCorrect && <Icon name="check" size={24} />}
                                                    </button>
                                                )
                                            })
                                        ) : (
                                            <div className="space-y-12 text-center">
                                                {!quizAnswered ? (
                                                    <button onClick={() => setQuizAnswered(true)} className="w-full py-32 border border-dashed border-gray-200 text-gray-300 font-bold uppercase tracking-[0.5em] hover:text-black hover:border-black transition-all flex flex-col items-center gap-6 group"><Icon name="eye" size={40} className="group-hover:scale-110 transition-transform" /> Access Archive</button>
                                                ) : (
                                                    <div className="p-16 bg-[#FAFAFA] border border-gray-100 animate-in italic font-serif text-3xl text-gray-600 leading-relaxed shadow-inner">
                                                        {activeItems[currentIdx].correct}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {activeItems[currentIdx].type === 'multiple' && !quizAnswered && (
                                        <button onClick={() => finishQuestion(selectedIdx)} disabled={selectedIdx.length === 0} className="w-full py-8 bg-black text-white text-xs font-bold tracking-[0.6em] uppercase hover:bg-gray-800 transition shadow-2xl font-bold">Confirm Selection</button>
                                    )}

                                    {quizAnswered && (
                                        <div className="pt-20 border-t border-gray-50 space-y-12 animate-in">
                                            <div className="flex justify-between items-start gap-16">
                                                <div className="body-text text-gray-400 italic flex-1">"Perspective: {activeItems[currentIdx].logic}"</div>
                                                <button onClick={() => generateExpertInsight(activeItems[currentIdx])} className="text-xs font-bold uppercase tracking-widest text-stone-500 hover:text-black transition whitespace-nowrap">âœ¨ Insight</button>
                                            </div>
                                            {expertInsight && <div className="p-12 bg-white border-l border-black text-base leading-loose text-stone-500 font-medium animate-in shadow-sm italic">{expertInsight}</div>}
                                            <button onClick={goToNext} className="w-full py-8 bg-black text-white text-xs font-bold tracking-[0.6em] uppercase hover:bg-gray-800 transition flex items-center justify-center gap-6 shadow-2xl font-bold">Next Episode <Icon name="arrowRight" size={20}/></button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'cards' && activeItems.length > 0 && (
                            <div className="max-w-4xl mx-auto animate-in">
                                <div className="flex justify-between items-center mb-16 relative">
                                    <div className="flex flex-col gap-2 text-center w-full">
                                        <span className="text-xs font-bold uppercase tracking-[0.6em] text-gray-300 font-medium">Focus {currentIdx + 1} / {activeItems.length}</span>
                                        <span className="text-[10px] text-stone-300 uppercase tracking-widest italic">Chapter {activeItems[currentIdx].chapter || 'Global'}</span>
                                    </div>
                                    <button onClick={() => setView('home')} className="absolute right-0 text-xs text-gray-300 hover:text-black uppercase font-bold tracking-widest transition">Close</button>
                                </div>
                                <div className="perspective-1000">
                                    <div onClick={() => setIsFlipped(!isFlipped)} className={`relative h-[650px] w-full transition-all duration-1000 preserve-3d cursor-pointer ${isFlipped ? 'rotate-y-180' : ''}`}>
                                        <div className="absolute inset-0 backface-hidden bg-white border border-gray-100 shadow-2xl p-20 flex flex-col items-center justify-center text-center">
                                            <div className="absolute top-16 left-1/2 -translate-x-1/2"><Icon name="circle" size={16} className="text-gray-100 animate-pulse" /></div>
                                            <p className="text-5xl font-light italic font-serif text-gray-900 leading-snug">{activeItems[currentIdx].front}</p>
                                            <span className="absolute bottom-20 font-bold text-[10px] text-gray-200 tracking-[0.8em] uppercase font-bold">Decode</span>
                                        </div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-black border border-black p-20 flex flex-col items-center justify-center text-center shadow-2xl">
                                            <p className="text-5xl font-light italic font-serif text-white leading-tight mb-12">{activeItems[currentIdx].back}</p>
                                            <p className="body-text text-gray-500 italic max-w-lg leading-relaxed">"{activeItems[currentIdx].logic}"</p>
                                        </div>
                                    </div>
                                </div>
                                <div className={`mt-20 flex gap-8 transition-all duration-1000 ${isFlipped ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-10 scale-95 pointer-events-none'}`}>
                                    <button onClick={() => updateCardStatus('forgotten')} className="flex-1 py-7 border border-gray-100 text-xs font-bold tracking-[0.4em] uppercase hover:bg-black hover:text-white transition shadow-sm font-bold">Forgotten</button>
                                    <button onClick={() => updateCardStatus('blurred')} className="flex-1 py-7 border border-gray-100 text-xs font-bold tracking-[0.4em] uppercase hover:bg-black hover:text-white transition shadow-sm font-bold">Blurred</button>
                                    <button onClick={() => updateCardStatus('mastered')} className="flex-1 py-7 bg-black text-white text-xs font-bold tracking-[0.4em] uppercase transition shadow-2xl font-bold">Mastered</button>
                                </div>
                            </div>
                        )}

                        {(view === 'burnbook' || view === 'manual-entry') && (
                            <div className="max-w-6xl mx-auto animate-in space-y-20">
                                <header className="flex justify-between items-end border-b border-gray-200 pb-12">
                                    <div className="space-y-4">
                                        <h2 className="text-7xl font-light italic font-serif text-gray-900">The Archive</h2>
                                        <button onClick={() => setView('manual-entry')} className="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-300 hover:text-black transition flex items-center gap-3"><Icon name="edit" size={14} /> Manual Contribution</button>
                                    </div>
                                    <button onClick={() => setView('home')} className="text-xs font-bold uppercase tracking-[0.6em] hover:opacity-50 transition font-bold">Return</button>
                                </header>
                                
                                {view === 'manual-entry' && (
                                    <div className="bg-white p-16 border border-gray-100 shadow-sm space-y-12 shadow-2xl animate-in">
                                        <h3 className="text-3xl font-light italic font-serif">Create Manual Entry</h3>
                                        <div className="space-y-12">
                                            <input value={manualMistake.question} onChange={e => setManualMistake({...manualMistake, question: e.target.value})} placeholder="The Question" className="w-full py-8 bg-transparent border-b border-gray-100 outline-none text-4xl font-serif italic" />
                                            <input value={manualMistake.correct} onChange={e => setManualMistake({...manualMistake, correct: e.target.value})} placeholder="The Truth (Answer)" className="w-full py-8 bg-transparent border-b border-gray-100 outline-none text-2xl font-medium" />
                                            <textarea value={manualMistake.logic} onChange={e => setManualMistake({...manualMistake, logic: e.target.value})} placeholder="The Perspective (Logic)" className="w-full h-40 bg-transparent border-b border-gray-100 outline-none body-text italic resize-none" />
                                            <div className="flex gap-8 pt-6">
                                                <button onClick={addManualMistake} className="flex-1 py-8 bg-black text-white text-xs font-bold uppercase tracking-[0.6em] shadow-2xl font-bold">Archive it</button>
                                                <button onClick={() => setView('burnbook')} className="px-12 py-8 border border-gray-100 text-xs font-bold uppercase tracking-[0.4em] font-bold">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {view === 'burnbook' && (
                                    mistakes.length === 0 ? (
                                        <div className="text-center py-60 border border-dashed border-gray-100 text-gray-200 uppercase tracking-[0.8em] font-medium text-sm small-caps">Pure Record // No Distortions Found</div>
                                    ) : (
                                        <div className="grid gap-20">
                                            {(mistakes || []).map((m, i) => (
                                                <div key={m.id || i} className="bg-white border border-gray-50 p-16 transition-all hover:shadow-2xl group relative overflow-hidden">
                                                    <div className="flex justify-between mb-12 relative z-10 text-gray-900">
                                                        <span className="text-[10px] font-bold tracking-[0.6em] text-gray-300 uppercase font-medium">Archive Entry {i+1}</span>
                                                        <button onClick={() => removeFromArchive(m.id)} className="text-gray-200 hover:text-black transition"><Icon name="trash" size={20} /></button>
                                                    </div>
                                                    <p className="text-5xl font-light italic font-serif text-gray-900 mb-16 relative z-10 leading-tight pr-12">{m.question}</p>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-16 relative z-10">
                                                        <div className="space-y-6 border-l border-black pl-10">
                                                            <span className="text-[10px] font-bold text-gray-300 uppercase tracking-[0.4em] block font-medium">The Detail</span>
                                                            <p className="text-2xl font-medium text-gray-700 italic leading-relaxed">
                                                                {m.type === 'open' ? m.correct : (Array.isArray(m.correct) ? m.correct.map(idx => (m.options && m.options[idx]) || 'N/A').join(', ') : (m.options && m.options[m.correct] !== undefined ? m.options[m.correct] : 'N/A'))}
                                                            </p>
                                                        </div>
                                                        <div className="space-y-6 text-base text-gray-400 italic font-medium leading-loose">
                                                            <span className="text-[10px] font-bold text-gray-300 uppercase tracking-[0.4em] block not-italic">The Perspective</span>
                                                            <p>"{m.logic}"</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
