<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRE / MULTIVERSE REMASTERED</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts Injection -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Inter:wght@300;400;600;900&family=Creepster&family=Caveat:wght@700&family=UnifrakturMaguntia&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    
    <style>
        /* Base Reset */
        body { margin: 0; overflow: hidden; transition: all 0.5s ease; user-select: none; }
        
        /* 3D Card Utils */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        /* Animation Utils */
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
            50% { text-shadow: 0 0 20px currentColor, 0 0 30px currentColor, 0 0 40px currentColor; }
        }
        .neon-text { animation: neonPulse 2s infinite alternate; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes floatTitle {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: floatTitle 6s ease-in-out infinite; }

        /* Pop Feedback Animation */
        @keyframes popUp {
            0% { opacity: 0; transform: translate(-50%, 20px) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -20px) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50px) scale(1); }
        }
        .feedback-pop {
            position: absolute;
            left: 50%;
            top: 40%;
            animation: popUp 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
        }

        /* Scanline Effect for Stranger Things */
        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. THEME ENGINE (COLOR REMASTERED) ---
        const THEMES = {
            obsidian: {
                id: 'obsidian',
                name: 'Obsidian Zen',
                bg: 'url(https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=2000&auto=format&fit=crop)', 
                fontTitle: "'Playfair Display', serif", 
                fontCard: "'Playfair Display', serif", 
                fontBody: "'Inter', sans-serif",
                accent: '#d4af37', // Classic Gold
                glass: 'rgba(0, 0, 0, 0.7)',
                text: '#e2e8f0',
                border: '1px solid rgba(212, 175, 55, 0.3)', // Subtle Gold Border
                overlay: 'rgba(0,0,0,0.6)',
                btnClass: 'rounded-lg border hover:bg-white/10'
            },
            westwood: {
                id: 'westwood',
                name: 'Westwood Punk',
                bg: 'url(https://images.unsplash.com/photo-1598556776374-2c3f8704288c?q=80&w=2000&auto=format&fit=crop)', 
                fontTitle: "'UnifrakturMaguntia', cursive", 
                fontCard: "'Playfair Display', serif", 
                fontBody: "'Inter', sans-serif", 
                accent: '#ff0000', // Anarchy Red
                glass: 'rgba(10, 10, 10, 0.95)', 
                text: '#ffffff',
                border: '3px solid #ff0000', // Aggressive Border
                overlay: 'rgba(0,0,0,0.6)',
                extraClass: 'uppercase tracking-wide',
                btnClass: 'border-2 border-red-600 hover:bg-red-600 hover:text-white transform -skew-x-12 shadow-[4px_4px_0px_0px_rgba(255,255,255,1)]' 
            },
            harryPotter: {
                id: 'harryPotter',
                name: 'Wizarding World',
                bg: 'linear-gradient(135deg, #2b1b17 0%, #4a3728 50%, #1a1a1a 100%)', // Deep Leather/Dark Wood
                fontTitle: "'Cinzel', serif", 
                fontCard: "'Cinzel', serif", 
                fontBody: "'Playfair Display', serif", 
                accent: '#ffc107', // Hufflepuff/Gryffindor Gold
                glass: 'rgba(30, 20, 10, 0.7)', 
                text: '#f5f5dc', // Parchment Text
                border: '1px solid rgba(255, 193, 7, 0.4)',
                overlay: 'rgba(0,0,0,0.3)',
                btnClass: 'rounded-full border border-amber-500/50 hover:bg-amber-900/40 hover:border-amber-400'
            },
            oldMoney: {
                id: 'oldMoney',
                name: 'Old Money',
                bg: 'url(https://images.unsplash.com/photo-1605218427368-35b80a37db79?q=80&w=2000&auto=format&fit=crop)', 
                fontTitle: "'Playfair Display', serif",
                fontCard: "'Playfair Display', serif",
                fontBody: "'Playfair Display', serif",
                accent: '#0c2461', // Deep Navy
                glass: 'rgba(240, 240, 235, 0.95)', // Cream/Linen
                text: '#0c2461', // Navy Text
                border: '1px solid #0c2461',
                overlay: 'rgba(255,255,255,0.1)',
                btnClass: 'rounded-sm border border-blue-900 text-blue-900 hover:bg-blue-900 hover:text-white font-semibold'
            },
            fantasy: {
                id: 'fantasy',
                name: 'Dark Fantasy',
                bg: 'url(https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=2000&auto=format&fit=crop)', 
                fontTitle: "'UnifrakturMaguntia', cursive", 
                fontCard: "'Cinzel', serif", 
                fontBody: "'Playfair Display', serif", 
                accent: '#a855f7', // Mystical Purple
                glass: 'rgba(15, 5, 25, 0.85)',
                text: '#e9d5ff', // Light Purple Text
                border: '1px solid #a855f7',
                overlay: 'rgba(0,0,0,0.5)',
                btnClass: 'rounded border border-purple-500 hover:shadow-[0_0_20px_#a855f7] hover:bg-purple-900/30'
            },
            meanGirls: {
                id: 'meanGirls',
                name: 'The Plastics',
                bg: 'url(https://images.unsplash.com/photo-1550920756-3c0f64dc9397?q=80&w=2000&auto=format&fit=crop)', 
                fontTitle: "'Caveat', cursive", 
                fontCard: "'Inter', sans-serif", 
                fontBody: "'Inter', sans-serif", 
                accent: '#ff1493', // Deep Pink
                glass: 'rgba(255, 235, 245, 0.95)',
                text: '#db2777', // Darker Pink Text
                border: '2px dashed #ff1493',
                overlay: 'rgba(255,255,255,0.3)',
                btnClass: 'rounded-xl border-2 border-pink-500 text-pink-600 hover:bg-pink-500 hover:text-white font-bold tracking-tighter'
            },
            strangerThings: {
                id: 'strangerThings',
                name: 'Upside Down',
                bg: 'url(https://images.unsplash.com/photo-1504609773096-104ff10587a2?q=80&w=2000&auto=format&fit=crop)', 
                fontTitle: "'Creepster', display", 
                fontCard: "'Inter', sans-serif", 
                fontBody: "'Inter', sans-serif", 
                accent: '#ff2222', // Neon Red
                glass: 'rgba(5, 5, 5, 0.92)',
                text: '#ff2222',
                border: '1px solid #ff2222',
                overlay: 'rgba(0,0,0,0.85)',
                extraClass: 'neon-text',
                btnClass: 'rounded border border-red-600 hover:bg-red-900/50 hover:shadow-[0_0_15px_#ff0000]',
                scanlines: true
            },
            cleanGirl: {
                id: 'cleanGirl',
                name: 'Clean Girl',
                bg: 'linear-gradient(135deg, #f0fdf4 0%, #f7fee7 100%)', // Very Light Mint/Sage
                fontTitle: "'Playfair Display', serif", 
                fontCard: "'Playfair Display', serif",
                fontBody: "'Inter', sans-serif",
                accent: '#65a30d', // Lime/Sage Green
                glass: 'rgba(255, 255, 255, 0.8)',
                text: '#44403c', // Stone Grey
                border: '1px solid #d6d3d1',
                overlay: 'rgba(255,255,255,0)',
                btnClass: 'rounded-full border border-stone-300 text-stone-600 hover:bg-[#65a30d] hover:text-white hover:border-[#65a30d] transition-colors duration-300'
            }
        };

        // --- 2. DATA LAYER (Persisted) ---
        const INITIAL_DATA = [
            { id: 101, word: "abandon", phonetic: "/ə'bændən/", meaning: "v. 放纵；放弃", example: "The scheme's investors, fearful of bankruptcy, decided to abandon the project.", mnemonic: "a+band(乐队)+on -> 乐队在台上'放纵'演奏", userSentence: "", tags: ["再要你命3000"], nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 102, word: "abate", phonetic: "/ə'beɪt/", meaning: "v. 减轻，减少", example: "We must wait for the storm to abate.", synonyms: "mitigate, curtail, temper, ameliorate", tags: ["六选二"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 103, word: "aberrant", phonetic: "/æ'berənt/", meaning: "adj. 异常的，非常规的", example: "Aberrant behavior can be a sign of stress.", synonyms: "anomaly", tags: ["再要你命3000"], mnemonic: "ab(离)+err(错误)+ant -> 离家出走犯错 -> 异常的", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 104, word: "cacophony", phonetic: "/kə'kɒfəni/", meaning: "n. 刺耳的声音", example: "A cacophony of deafening alarm bells.", tags: ["GRE核心"], mnemonic: "caco(坏)+phon(声音)", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 105, word: "enervate", phonetic: "/'enəveɪt/", meaning: "v. 使衰弱", example: "The heat enervated us all.", tags: ["易混淆"], mnemonic: "e(出)+nerv(神经) -> 神经出来了 -> 衰弱", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 106, word: "ephemeral", phonetic: "/ɪ'femərəl/", meaning: "adj. 短暂的", example: "Fashions are ephemeral, changing with every season.", synonyms: "transient, evanescent", tags: ["高频"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 107, word: "garrulous", phonetic: "/'ɡærələs/", meaning: "adj. 唠叨的，多嘴的", example: "He became positively garrulous after a few glasses of wine.", synonyms: "loquacious, verbose", tags: ["阅读机经"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 108, word: "iconoclast", phonetic: "/aɪ'kɒnəklæst/", meaning: "n. 特立独行的人；打破旧习者", example: "Ideally, the press should be an iconoclast.", tags: ["镇考3000"], mnemonic: "icon(偶像)+clast(打碎) -> 打碎偶像的人", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 109, word: "mitigate", phonetic: "/'mɪtɪɡeɪt/", meaning: "v. 缓和，减轻", example: "Emergency funds are being provided to mitigate the effects of the disaster.", synonyms: "abate, curtail, temper, ameliorate", tags: ["六选二同义词"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 110, word: "proliferate", phonetic: "/prə'lɪfəreɪt/", meaning: "v. 激增，繁殖", example: "Small businesses have proliferated in the last ten years.", synonyms: "abound", tags: ["六选二同义词"], mnemonic: "pro(前)+life(生命)+rate -> 生命力向前的速率 -> 繁殖", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 111, word: "quiescent", phonetic: "/kwi'esnt/", meaning: "adj. 静止的，不活动的", example: "Strikes were headed by groups of workers who had previously been quiescent.", synonyms: "abeyant, calm", tags: ["六选二同义词"], mnemonic: "quiet+scent", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 112, word: "tacit", phonetic: "/'tæsɪt/", meaning: "adj. 缄默的；不言而喻的", example: "There was a tacit agreement that he would pay for the meal.", tags: ["阅读机经"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 113, word: "unanimous", phonetic: "/ju'nænɪməs/", meaning: "adj. 一致同意的", example: "The decision was unanimous.", tags: ["再要你命3000"], mnemonic: "uni(一)+anim(精神) -> 一个精神 -> 一致", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 114, word: "vile", phonetic: "/vaɪl/", meaning: "adj. 丑陋的；卑鄙的", example: "A vile smell.", tags: ["再要你命3000"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 115, word: "wrest", phonetic: "/rest/", meaning: "v. 抢夺；费力取得", example: "They attempted to wrest control of the town.", tags: ["镇考3000"], mnemonic: "wrestle(摔跤) -> 抢夺", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 116, word: "xenophobic", phonetic: "/ˌzenəˈfəʊbɪk/", meaning: "adj. 排外的，恐惧外国人的", example: "The French are proud and highly xenophobic when it comes to cooking.", tags: ["镇考3000"], mnemonic: "xeno(外)+phobia(恐惧)", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 117, word: "yearn", phonetic: "/jɜːn/", meaning: "v. 渴望，向往", example: "The people yearned for peace.", tags: ["镇考3000"], mnemonic: "", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
            { id: 118, word: "zealot", phonetic: "/'zelət/", meaning: "n. 狂热者", example: "I am an index believer, but not a zealot.", synonyms: "extremist, ideologue", tags: ["镇考3000"], mnemonic: "zeal(热情)+lot(多) -> 热情太多 -> 狂热者", userSentence: "", nextReview: Date.now(), interval: 0, ease: 2.5 },
        ];

        const calculateNextReview = (card, quality) => {
            let { interval, ease, reviewCount = 0 } = card;
            if (quality === 0) { interval = 0; reviewCount = 0; }
            else {
                if (reviewCount === 0) interval = 1;
                else if (reviewCount === 1) interval = 3;
                else interval = Math.round(interval * ease);
                reviewCount++;
            }
            ease = Math.max(1.3, ease + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
            let nextReviewTime = interval === 0 ? Date.now() + 60000 : Date.now() + (interval * 24 * 60 * 60 * 1000); 
            return { ...card, interval, ease, reviewCount, nextReview: nextReviewTime };
        };

        const App = () => {
            // --- STATE ---
            const [cards, setCards] = useState(() => JSON.parse(localStorage.getItem('gre_v11_cards')) || INITIAL_DATA);
            const [settings, setSettings] = useState(() => JSON.parse(localStorage.getItem('gre_v11_settings')) || { contextMode: false, theme: 'obsidian' });
            
            // TIMELINE & DAILY STATS
            const [startDate, setStartDate] = useState(() => {
                const saved = localStorage.getItem('gre_start_date');
                return saved ? parseInt(saved) : Date.now();
            });
            const [dailyLog, setDailyLog] = useState(() => {
                const saved = localStorage.getItem('gre_daily_log');
                const today = new Date().toDateString();
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.date === today) return parsed;
                }
                return { date: today, newCount: 0 };
            });

            const [view, setView] = useState('home'); 
            const [queue, setQueue] = useState([]);
            const [curr, setCurr] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [sessionType, setSessionType] = useState('mix'); // 'new', 'review', 'hard'
            
            // GAMIFICATION STATE
            const [combo, setCombo] = useState(0);
            const [xp, setXp] = useState(0);
            const [feedback, setFeedback] = useState(null); 

            const fileInputRef = useRef(null);

            const theme = THEMES[settings.theme] || THEMES.obsidian;

            // Persistence
            useEffect(() => localStorage.setItem('gre_v11_cards', JSON.stringify(cards)), [cards]);
            useEffect(() => localStorage.setItem('gre_v11_settings', JSON.stringify(settings)), [settings]);
            useEffect(() => localStorage.setItem('gre_start_date', startDate), [startDate]);
            useEffect(() => localStorage.setItem('gre_daily_log', JSON.stringify(dailyLog)), [dailyLog]);

            // Daily Reset Check on Load
            useEffect(() => {
                const today = new Date().toDateString();
                if (dailyLog.date !== today) {
                    setDailyLog({ date: today, newCount: 0 });
                }
            }, []);

            // Stats Calculation
            const stats = useMemo(() => {
                const now = Date.now();
                return {
                    total: cards.length,
                    due: cards.filter(c => c.nextReview <= now && c.interval > 0).length,
                    newAvailable: cards.filter(c => c.interval === 0).length,
                    mastered: cards.filter(c => c.interval > 21).length,
                    hard: cards.filter(c => c.ease < 2.3 && c.reviewCount > 0).length
                };
            }, [cards]);

            // Timeline Logic
            const currentDay = Math.floor((Date.now() - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const totalDays = 60;
            const dailyNewQuota = currentDay <= 45 ? 50 : 0;
            const newWordsLeftToday = Math.max(0, dailyNewQuota - dailyLog.newCount);

            // Keyboard
            useEffect(() => {
                const handleKey = (e) => {
                    if (view !== 'study') return;
                    if (e.code === 'Space') { e.preventDefault(); setFlipped(p => !p); }
                    if (flipped) {
                        if (e.key === '1') handleRate(0); 
                        if (e.key === '2') handleRate(3); 
                        if (e.key === '3') handleRate(4); 
                        if (e.key === '4') handleRate(5); 
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [view, flipped, curr, queue]);

            // Handlers
            const startSession = (mode) => {
                const now = Date.now();
                let q = [];
                setSessionType(mode);

                if (mode === 'new') {
                    if (newWordsLeftToday <= 0) {
                        alert("Daily new word quota reached! Good job. Focus on review.");
                        return;
                    }
                    q = cards.filter(c => c.interval === 0).slice(0, newWordsLeftToday);
                    if (q.length === 0) {
                        alert("No new words available in database! Import more data.");
                        return;
                    }
                } else if (mode === 'review') {
                    q = cards.filter(c => c.nextReview <= now && c.interval > 0).sort((a,b) => a.nextReview - b.nextReview);
                    if (q.length === 0) {
                        alert("No reviews due right now!");
                        return;
                    }
                } else if (mode === 'hard') {
                    q = cards.filter(c => c.ease < 2.3 && c.reviewCount > 0);
                    if (q.length === 0) {
                        alert("No mistakes found. Perfect!");
                        return;
                    }
                }
                
                setQueue(q);
                setCurr(0);
                setFlipped(false);
                setCombo(0); 
                setXp(0); 
                setView('study');
            };

            const handleRate = (quality) => {
                const currentCard = queue[curr];
                const wasNew = currentCard.interval === 0;
                const updated = calculateNextReview(currentCard, quality);
                setCards(prev => prev.map(c => c.id === updated.id ? updated : c));
                
                if (sessionType === 'new' && wasNew && quality > 0) {
                    setDailyLog(prev => ({ ...prev, newCount: prev.newCount + 1 }));
                }

                if (quality >= 4) {
                    const newCombo = combo + 1;
                    setCombo(newCombo);
                    const gain = 10 + (newCombo * 2);
                    setXp(p => p + gain);
                    triggerFeedback(quality === 5 ? "PERFECT" : "GOOD", `+${gain} XP`, theme.accent);
                } else {
                    setCombo(0);
                    triggerFeedback(quality === 3 ? "HARD" : "FORGET", "Keep Going", "#ef4444");
                }

                if (curr < queue.length - 1) {
                    setFlipped(false);
                    setTimeout(() => setCurr(prev => prev + 1), 200); 
                } else {
                    setView('home');
                }
            };

            const triggerFeedback = (mainText, subText, color) => {
                setFeedback({ main: mainText, sub: subText, color: color, id: Date.now() });
                setTimeout(() => setFeedback(null), 800);
            };

            const updateCardField = (id, field, value) => {
                const updatedQueue = [...queue];
                updatedQueue[curr] = { ...updatedQueue[curr], [field]: value };
                setQueue(updatedQueue); 
                setCards(prev => prev.map(c => c.id === id ? { ...c, [field]: value } : c)); 
            };

            const handleImportText = (text) => {
                try {
                    const json = JSON.parse(text);
                    if (Array.isArray(json)) {
                        const newCards = json.map((item, idx) => ({
                            id: Date.now() + idx,
                            word: item.word || "Unknown",
                            meaning: item.meaning || "No definition",
                            example: item.example || "No context provided.",
                            phonetic: item.phonetic || "",
                            mnemonic: item.mnemonic || "",
                            userSentence: item.userSentence || "",
                            tags: ["Imported"], nextReview: Date.now(), interval: 0, ease: 2.5
                        }));
                        setCards([...cards, ...newCards]);
                        alert(`JSON Import Successful: Added ${newCards.length} words.`);
                        setView('home');
                        return;
                    }
                } catch(e) {}

                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length === 0) return;

                const newCards = lines.map((line, idx) => {
                    let parts;
                    if (line.includes('\t')) parts = line.split('\t'); 
                    else if (line.includes('|')) parts = line.split('|');
                    else if (line.includes('，')) parts = line.split('，');
                    else parts = line.split(',');
                    
                    const word = parts[0] ? parts[0].trim() : "Unknown";
                    const meaning = parts[1] ? parts[1].trim() : "No definition";
                    const example = parts.length > 2 ? parts.slice(2).join(', ').trim() : "No context provided.";

                    return {
                        id: Date.now() + idx,
                        word, meaning, example,
                        phonetic: "", mnemonic: "", userSentence: "", tags: ["Imported"], nextReview: Date.now(), interval: 0, ease: 2.5
                    };
                });
                
                if (newCards.length > 0) {
                    setCards([...cards, ...newCards]);
                    alert(`Text Import Successful: Added ${newCards.length} words.`);
                    setView('home');
                } else {
                    alert("Could not parse. Try pasting from Excel.");
                }
            };
            
            const exportData = () => {
                const dataStr = JSON.stringify(cards);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', `gre_multiverse_backup.json`);
                linkElement.click();
            };
            
            const handleFileImport = (e) => {
                const fileReader = new FileReader();
                fileReader.readAsText(e.target.files[0], "UTF-8");
                fileReader.onload = (e) => {
                    try {
                        const importedCards = JSON.parse(e.target.result);
                        if (Array.isArray(importedCards)) {
                            if(confirm(`Restore ${importedCards.length} words?`)) { setCards(importedCards); setView('home'); }
                        }
                    } catch (error) { alert("Invalid File"); }
                };
            };

            // --- RENDER HELPERS ---
            const appStyle = {
                fontFamily: theme.fontBody,
                color: theme.text,
                background: theme.bg, 
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                backgroundRepeat: 'no-repeat'
            };
            
            const cardStyle = {
                background: theme.glass,
                border: theme.border,
                color: theme.text,
                boxShadow: `0 8px 32px 0 rgba(0,0,0,0.5)`
            };

            return (
                <div className={`h-screen w-full flex flex-col relative transition-all duration-700 ${theme.extraClass || ''}`} style={appStyle}>
                    <div className="absolute inset-0 z-0 transition-all duration-700" style={{ backgroundColor: theme.overlay }}></div>
                    {theme.scanlines && <div className="scanlines"></div>}

                    {/* HUD - Navbar */}
                    <nav className="relative z-20 p-6 flex justify-between items-center text-xs tracking-[0.2em] uppercase w-full">
                        <div className="flex gap-4 md:gap-8 items-center">
                            <span className="font-bold cursor-pointer hover:opacity-80" onClick={() => setView('home')} style={{ color: theme.accent }}>GRE / {theme.name}</span>
                            <select 
                                value={settings.theme}
                                onChange={(e) => setSettings(s => ({...s, theme: e.target.value}))}
                                className="bg-transparent border-none outline-none cursor-pointer uppercase font-bold text-[10px] md:text-xs opacity-60 hover:opacity-100"
                                style={{ color: theme.text }}
                            >
                                {Object.values(THEMES).map(t => <option key={t.id} value={t.id} className="text-black">{t.name}</option>)}
                            </select>
                        </div>
                        
                        <div className="flex gap-6 items-center">
                            <span className="cursor-pointer hover:opacity-80 transition flex items-center gap-1" onClick={() => setView('plan')} style={{ color: view === 'plan' ? theme.accent : 'inherit' }}>
                                <i className="fas fa-calendar-alt"></i> Plan
                            </span>
                            {/* XP BAR */}
                            {xp > 0 && (
                                <div className="hidden md:flex items-center gap-2">
                                    <span className="text-[10px]" style={{color: theme.accent}}>XP</span>
                                    <div className="w-24 h-1 bg-gray-700 rounded-full overflow-hidden">
                                        <div className="h-full transition-all duration-1000" style={{width: `${Math.min(100, xp/5)}%`, backgroundColor: theme.accent}}></div>
                                    </div>
                                    <span className="font-bold">{xp}</span>
                                </div>
                            )}
                            <span className="cursor-pointer hover:opacity-80 transition" onClick={() => startSession('hard')} style={{ color: stats.hard > 0 ? '#ef4444' : 'inherit' }}>
                                <i className="fas fa-bug"></i> Mistakes ({stats.hard})
                            </span>
                            <span className="cursor-pointer hover:opacity-80 transition" onClick={() => setView('data')}>Data</span>
                            <label className="flex items-center gap-2 cursor-pointer hover:opacity-80 transition">
                                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: settings.contextMode ? theme.accent : '#555' }}></div>
                                <span className="hidden md:inline">Context</span>
                                <input type="checkbox" className="hidden" checked={settings.contextMode} onChange={() => setSettings(s => ({...s, contextMode: !s.contextMode}))} />
                            </label>
                        </div>
                    </nav>

                    {/* Main Stage */}
                    <div className="relative z-10 flex-1 flex flex-col items-center justify-center p-4 w-full max-w-5xl mx-auto">
                        
                        {/* VIEW: HOME */}
                        {view === 'home' && (
                            <div className="text-center animate-fade-in w-full">
                                <div className="animate-float mb-8">
                                    <h1 style={{ fontFamily: theme.fontTitle }} className="text-5xl md:text-8xl leading-tight">
                                        Verbal <br/>
                                        <span style={{ color: theme.accent }} className="italic">Mastery</span>
                                    </h1>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto mb-12">
                                    {/* LEARN NEW BUTTON */}
                                    <div 
                                        onClick={() => startSession('new')}
                                        className={`glass p-6 rounded-lg cursor-pointer transition-all hover:transform hover:scale-105 group relative overflow-hidden ${newWordsLeftToday === 0 ? 'opacity-50 pointer-events-none' : ''}`}
                                        style={{borderColor: theme.border}}
                                    >
                                        <div className="absolute top-0 left-0 w-1 h-full" style={{backgroundColor: theme.accent}}></div>
                                        <h3 className="text-xl font-bold mb-1 transition-colors" style={{fontFamily: theme.fontTitle, color: theme.text}}>Learn New</h3>
                                        <div className="flex justify-between items-end">
                                            <span className="text-xs uppercase tracking-widest opacity-60">Daily Quota</span>
                                            <span className="text-2xl font-bold">{dailyLog.newCount} / {dailyNewQuota}</span>
                                        </div>
                                    </div>

                                    {/* REVIEW BUTTON */}
                                    <div 
                                        onClick={() => startSession('review')}
                                        className="glass p-6 rounded-lg cursor-pointer transition-all hover:transform hover:scale-105 group relative overflow-hidden"
                                        style={{borderColor: theme.border}}
                                    >
                                        <div className="absolute top-0 left-0 w-1 h-full" style={{backgroundColor: theme.accent}}></div>
                                        <h3 className="text-xl font-bold mb-1 transition-colors" style={{fontFamily: theme.fontTitle, color: theme.text}}>Review Due</h3>
                                        <div className="flex justify-between items-end">
                                            <span className="text-xs uppercase tracking-widest opacity-60">To Review</span>
                                            <span className="text-2xl font-bold" style={{color: stats.due > 0 ? theme.accent : 'inherit'}}>{stats.due}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="text-center opacity-50 text-[10px] uppercase tracking-widest">
                                    Day {currentDay} of 60
                                </div>
                            </div>
                        )}

                        {/* VIEW: STUDY */}
                        {view === 'study' && queue.length > 0 && (
                            <div className="w-full max-w-2xl flex flex-col items-center relative">
                                
                                {/* COMBO COUNTER */}
                                {combo > 1 && (
                                    <div className="absolute -top-16 animate-bounce font-bold text-2xl tracking-widest z-50" style={{color: theme.accent, textShadow: '0 0 10px rgba(0,0,0,0.5)'}}>
                                        COMBO x{combo} <i className="fas fa-fire"></i>
                                    </div>
                                )}

                                {/* FEEDBACK POPUP */}
                                {feedback && (
                                    <div key={feedback.id} className="feedback-pop text-center">
                                        <div className="text-4xl font-black italic" style={{color: feedback.color, textShadow: '0 2px 10px rgba(0,0,0,0.5)'}}>{feedback.main}</div>
                                        <div className="text-sm font-bold mt-1 text-white">{feedback.sub}</div>
                                    </div>
                                )}

                                <div className="w-full h-1 bg-gray-700/30 mb-8 rounded-full overflow-hidden">
                                    <div className="h-full transition-all duration-500" style={{ width: `${(curr / queue.length) * 100}%`, backgroundColor: theme.accent }}></div>
                                </div>

                                <div 
                                    className="relative w-full h-[500px] perspective-1000 cursor-pointer group"
                                    onClick={(e) => {
                                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                                        setFlipped(!flipped);
                                    }}
                                >
                                    <div className={`relative w-full h-full transition-transform duration-700 preserve-3d ${flipped ? 'rotate-y-180' : ''}`}>
                                        
                                        {/* FRONT */}
                                        <div className="absolute inset-0 rounded-lg backface-hidden flex flex-col items-center justify-center p-12 text-center" style={cardStyle}>
                                            <div className="absolute top-6 right-6 text-[10px] uppercase tracking-widest opacity-50 px-2 py-1 border rounded" style={{borderColor: theme.border}}>
                                                {sessionType === 'new' ? 'New Word' : 'Review'}
                                            </div>
                                            {settings.contextMode ? (
                                                <div className="space-y-6">
                                                    <span className="text-[10px] uppercase tracking-widest opacity-60" style={{ color: theme.accent }}>Context Challenge</span>
                                                    <p style={{ fontFamily: theme.fontCard }} className="text-2xl leading-relaxed opacity-90">
                                                        "{queue[curr].example.replace(new RegExp(queue[curr].word, 'gi'), '_____')}"
                                                    </p>
                                                    <p className="text-[10px] uppercase tracking-widest opacity-50 mt-8">Tap to Reveal</p>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    <h2 style={{ fontFamily: theme.fontCard }} className="text-6xl md:text-7xl tracking-tight">{queue[curr].word}</h2>
                                                    <p className="text-xl italic opacity-70" style={{ color: theme.accent }}>{queue[curr].phonetic}</p>
                                                    <p className="absolute bottom-8 text-[10px] uppercase tracking-widest opacity-50">Space to Flip</p>
                                                </div>
                                            )}
                                        </div>

                                        {/* BACK */}
                                        <div className="absolute inset-0 rounded-lg backface-hidden rotate-y-180 flex flex-col p-8 md:p-10" style={{ ...cardStyle, transform: 'rotateY(180deg)' }}>
                                            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                                                <div className="flex justify-between items-baseline mb-4 pb-4 border-b" style={{ borderColor: theme.border }}>
                                                    <h2 style={{ fontFamily: theme.fontCard }} className="text-3xl">{queue[curr].word}</h2>
                                                    <span className="text-[10px] uppercase tracking-widest px-2 py-1 rounded bg-black/20 opacity-70">
                                                        {queue[curr].ease < 2.3 ? 'Hard' : 'Review'}
                                                    </span>
                                                </div>

                                                <div className="space-y-6 text-sm md:text-base">
                                                    <div>
                                                        <p className="opacity-90 leading-relaxed" style={{fontFamily: theme.fontBody}}>{queue[curr].meaning}</p>
                                                        {queue[curr].synonyms && <p className="text-xs opacity-60 mt-2">Syn: {queue[curr].synonyms}</p>}
                                                    </div>
                                                    
                                                    <div className="pl-4 border-l-2" style={{ borderColor: theme.accent }}>
                                                        <p className="text-xs uppercase tracking-widest opacity-50 mb-1">Context</p>
                                                        <p className="italic opacity-80" style={{fontFamily: theme.fontBody}}>"{queue[curr].example}"</p>
                                                    </div>

                                                    <div className="space-y-4 pt-4 border-t" style={{ borderColor: theme.border }}>
                                                        <div>
                                                            <label className="text-[10px] uppercase tracking-widest opacity-60 block mb-1">Memory Palace</label>
                                                            <input 
                                                                type="text" 
                                                                className="w-full bg-transparent border-b focus:outline-none py-1 text-sm transition-colors"
                                                                style={{ borderColor: theme.border, color: theme.accent }}
                                                                placeholder="Add visual hook..."
                                                                value={queue[curr].mnemonic}
                                                                onChange={(e) => updateCardField(queue[curr].id, 'mnemonic', e.target.value)}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-[10px] uppercase tracking-widest opacity-60 block mb-1">My Sentence</label>
                                                            <input 
                                                                type="text" 
                                                                className="w-full bg-transparent border-b focus:outline-none py-1 text-sm transition-colors"
                                                                style={{ borderColor: theme.border, color: theme.accent }}
                                                                placeholder="Self-reference..."
                                                                value={queue[curr].userSentence}
                                                                onChange={(e) => updateCardField(queue[curr].id, 'userSentence', e.target.value)}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-4 gap-2 mt-4 pt-4 border-t" style={{ borderColor: theme.border }}>
                                                {['Forget', 'Hard', 'Good', 'Easy'].map((label, idx) => (
                                                    <button 
                                                        key={label}
                                                        onClick={(e) => { e.stopPropagation(); handleRate([0,3,4,5][idx]); }}
                                                        className={`text-[10px] uppercase py-3 transition tracking-widest opacity-80 hover:opacity-100 hover:scale-105 ${theme.btnClass}`}
                                                        style={{ color: theme.text }}
                                                    >
                                                        {label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: PLAN */}
                        {view === 'plan' && (
                            <div className="glass p-10 max-w-4xl mx-auto animate-fade-in" style={cardStyle}>
                                <h2 style={{fontFamily: theme.fontTitle}} className="text-3xl mb-6 border-b pb-4" style={{borderColor: theme.border}}>Battle Plan</h2>
                                
                                <div className="mb-8 text-center">
                                    <div className="text-[10px] uppercase tracking-widest opacity-60">Current Progress</div>
                                    <div className="text-6xl font-bold my-4" style={{color: theme.accent, fontFamily: theme.fontTitle}}>Day {currentDay}</div>
                                    <div className="w-full bg-black/30 h-2 rounded-full mt-2">
                                        <div className="h-full transition-all duration-1000 rounded-full" style={{width: `${Math.min(100, (currentDay/60)*100)}%`, backgroundColor: theme.accent}}></div>
                                    </div>
                                    <div className="flex justify-between text-[10px] mt-2 opacity-50 uppercase tracking-widest">
                                        <span>Start</span>
                                        <span>Victory (Day 60)</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="p-6 border rounded-lg bg-black/20" style={{borderColor: theme.border}}>
                                        <h3 className="text-xl mb-4 font-bold" style={{fontFamily: theme.fontTitle}}>Today's Mission</h3>
                                        <ul className="space-y-4 text-sm">
                                            <li className="flex justify-between items-center border-b border-white/10 pb-2">
                                                <span className="opacity-70 uppercase tracking-widest text-[10px]">New Words Goal</span>
                                                <span className="font-mono text-lg font-bold" style={{color: theme.accent}}>{dailyLog.newCount} / {dailyNewQuota}</span>
                                            </li>
                                            <li className="flex justify-between items-center border-b border-white/10 pb-2">
                                                <span className="opacity-70 uppercase tracking-widest text-[10px]">Review Due</span>
                                                <span className="font-mono text-lg font-bold">{stats.due}</span>
                                            </li>
                                            <li className="flex justify-between items-center pt-2">
                                                <span className="opacity-70 uppercase tracking-widest text-[10px]">Phase</span>
                                                <span className="text-[10px] uppercase px-2 py-1 rounded bg-white/10 font-bold tracking-widest">
                                                    {currentDay <= 45 ? 'Acquisition' : 'Mastery'}
                                                </span>
                                            </li>
                                        </ul>
                                        {cards.length < 1000 && (
                                            <div className="mt-4 p-3 bg-red-900/30 border border-red-900/50 rounded text-xs text-red-300">
                                                <i className="fas fa-exclamation-triangle mr-2"></i> Low Data. Please Import 3000 Words.
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="p-6 rounded-lg bg-white/5 border" style={{borderColor: theme.border}}>
                                        <h3 className="text-xl mb-4 font-bold" style={{fontFamily: theme.fontTitle}}>60-Day Roadmap</h3>
                                        <div className="space-y-6 text-sm">
                                            <div className={`p-3 rounded ${currentDay <= 45 ? "bg-white/10 border-l-2" : "opacity-30"}`} style={{borderColor: theme.accent}}>
                                                <strong style={{color: theme.accent, fontFamily: theme.fontTitle}}>Phase 1 (Day 1-45)</strong> 
                                                <p className="opacity-70 mt-1 text-xs leading-relaxed">Aggressive intake. Learn 50 new words daily. Complete SRS reviews.</p>
                                            </div>
                                            <div className={`p-3 rounded ${currentDay > 45 ? "bg-white/10 border-l-2" : "opacity-30"}`} style={{borderColor: theme.accent}}>
                                                <strong style={{color: theme.accent, fontFamily: theme.fontTitle}}>Phase 2 (Day 46-60)</strong>
                                                <p className="opacity-70 mt-1 text-xs leading-relaxed">Zero new words. Clear Mistake Notebook (Hard words). Full consolidation.</p>
                                            </div>
                                        </div>
                                        <button onClick={() => {
                                            if(confirm("Reset schedule to Day 1? This cannot be undone.")) {
                                                setStartDate(Date.now());
                                            }
                                        }} className="mt-6 text-[10px] underline opacity-40 hover:opacity-100 uppercase tracking-widest w-full text-center">
                                            Reset Schedule Timer
                                        </button>
                                    </div>
                                </div>
                                
                                <button onClick={() => setView('home')} className="mt-8 w-full py-3 opacity-50 hover:opacity-100 uppercase tracking-widest text-xs border border-transparent hover:border-white/20 transition-all rounded">Back to Base</button>
                            </div>
                        )}

                        {/* VIEW: DATA */}
                        {view === 'data' && (
                            <div className="max-w-3xl mx-auto p-10 rounded-lg animate-fade-in" style={cardStyle}>
                                <h2 style={{ fontFamily: theme.fontTitle }} className="text-2xl mb-6 border-b pb-4" style={{ borderColor: theme.border }}>Archives</h2>
                                
                                <div className="space-y-6">
                                    <div>
                                        <p className="text-[10px] uppercase tracking-widest opacity-60 mb-2">Mass Injection (Excel/CSV/Text)</p>
                                        <textarea 
                                            id="importArea" 
                                            className="w-full h-24 bg-black/20 border p-3 text-xs outline-none resize-none custom-scrollbar" 
                                            style={{ borderColor: theme.border, color: theme.text }}
                                            placeholder={`Supported formats:\n1. Excel Copy-Paste (Tab separated)\n2. JSON Array\n3. CSV (Word, Meaning, Example)`}
                                        ></textarea>
                                        <button 
                                            onClick={() => handleImportText(document.getElementById('importArea').value)}
                                            className={`mt-2 w-full py-2 transition text-[10px] uppercase tracking-widest font-bold ${theme.btnClass}`}
                                            style={{ backgroundColor: theme.accent, color: theme.id === 'meanGirls' ? '#fff' : '#000' }}
                                        >
                                            Smart Inject Data
                                        </button>
                                    </div>

                                    <div className="flex gap-4">
                                        <button onClick={exportData} className="flex-1 py-3 border hover:bg-white/5 transition text-[10px] uppercase tracking-widest" style={{ borderColor: theme.border }}>
                                            Backup JSON
                                        </button>
                                        <button onClick={() => fileInputRef.current.click()} className="flex-1 py-3 border hover:bg-white/5 transition text-[10px] uppercase tracking-widest" style={{ borderColor: theme.border }}>
                                            Restore JSON
                                        </button>
                                        <input type="file" ref={fileInputRef} onChange={handleFileImport} className="hidden" accept=".json" />
                                    </div>
                                    
                                    <button onClick={() => setView('home')} className="mt-4 w-full text-[10px] uppercase tracking-widest opacity-50 hover:opacity-100">Back</button>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
