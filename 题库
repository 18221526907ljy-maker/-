import React, { useState, useEffect, useMemo } from 'react';
import { 
  Sparkles, 
  Plus, 
  Play, 
  Trash2, 
  ChevronLeft, 
  Check, 
  X, 
  ArrowRight,
  Flame,
  Layout,
  Star,
  Zap,
  ClipboardList,
  Eye,
  RefreshCw,
  Edit3,
  RotateCcw,
  BookOpen,
  Smile,
  Frown,
  Meh,
  Briefcase,
  Globe,
  Wallet,
  FileSpreadsheet,
  Layers,
  Circle
} from 'lucide-react';

const apiKey = ""; // 运行时由环境自动提供

// --- Hailey / High Fashion Theme (Muted Earth Tones) ---
const SUBJECTS = [
  { id: 'brand', name: '品牌管理', label: 'THE LABEL', color: 'from-[#2D2D2D] to-[#1A1A1A]', accent: '#2D2D2D', icon: <Layers size={20} /> },
  { id: 'marketing', name: '营销渠道', label: 'DISTRIBUTION', color: 'from-[#8E8E93] to-[#636366]', accent: '#636366', icon: <Globe size={20} /> },
  { id: 'finance', name: '财务管理', label: 'CAPITAL', color: 'from-[#D4C3B3] to-[#A08E7D]', accent: '#A08E7D', icon: <Wallet size={20} /> }
];

const App = () => {
  const [view, setView] = useState('home'); 
  const [activeSubject, setActiveSubject] = useState(SUBJECTS[0]);
  
  // Data Persistence in Memory (Init with 3 subjects)
  const [db, setDb] = useState({ 
    brand: { questions: [], cards: [] }, 
    marketing: { questions: [], cards: [] }, 
    finance: { questions: [], cards: [] } 
  });
  const [mistakes, setMistakes] = useState([]);
  
  // Session States
  const [activeItems, setActiveItems] = useState([]);
  const [currentIdx, setCurrentIdx] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);
  const [quizAnswered, setQuizAnswered] = useState(false);
  const [selectedIdx, setSelectedIdx] = useState(null);

  // Import States
  const [rawText, setRawText] = useState('');
  const [isParsing, setIsParsing] = useState(false);
  const [importType, setImportType] = useState('question');

  // --- AI Logic: Intelligent Parsing ---
  const parseData = async () => {
    if (!rawText.trim()) return;
    setIsParsing(true);
    
    const systemPrompt = importType === 'question' 
      ? `将文本解析为考试题目JSON数组: [{type: 'single'|'multiple'|'open', question, options[], correct, logic}]。语气要专业、简洁，像时尚杂志编辑。`
      : `将文本或Excel内容解析为闪卡JSON数组: [{front, back, logic}]。风格要极简高级。`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `解析以下${importType === 'card' ? '闪卡' : '题目'}内容：\n${rawText}` }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });
      
      const result = await response.json();
      const parsed = JSON.parse(result.candidates[0].content.parts[0].text);
      
      const newItems = parsed.map(item => ({ 
        ...item, 
        id: crypto.randomUUID(), 
        status: null,
        subjectId: activeSubject.id 
      }));

      setDb(prev => ({
        ...prev,
        [activeSubject.id]: {
          ...prev[activeSubject.id],
          [importType === 'question' ? 'questions' : 'cards']: [
            ...prev[activeSubject.id][importType === 'question' ? 'questions' : 'cards'],
            ...newItems
          ]
        }
      }));
      setRawText('');
      setView('home');
    } catch (e) {
      console.error("Parsing failed", e);
    } finally {
      setIsParsing(false);
    }
  };

  // --- Session Management ---
  const startSession = (mode, type) => {
    let pool = type === 'cards' ? db[activeSubject.id].cards : db[activeSubject.id].questions;
    if (mode === 'forgotten') pool = pool.filter(c => c.status === 'forgotten');
    if (mode === 'blurred') pool = pool.filter(c => c.status === 'blurred');
    
    if (pool.length === 0) return;
    setActiveItems([...pool].sort(() => Math.random() - 0.5));
    setCurrentIdx(0);
    setIsFlipped(false);
    setQuizAnswered(false);
    setSelectedIdx(null);
    setView(type);
  };

  const handleQuizAnswer = (idx) => {
    if (quizAnswered) return;
    setSelectedIdx(idx);
    setQuizAnswered(true);
    const q = activeItems[currentIdx];
    if (idx !== q.correct) {
      setMistakes(prev => prev.find(m => m.id === q.id) ? prev : [...prev, q]);
    }
  };

  const updateCardStatus = (status) => {
    const cardId = activeItems[currentIdx].id;
    setDb(prev => ({
      ...prev,
      [activeSubject.id]: {
        ...prev[activeSubject.id],
        cards: prev[activeSubject.id].cards.map(c => c.id === cardId ? { ...c, status } : c)
      }
    }));
    if (currentIdx + 1 < activeItems.length) {
      setCurrentIdx(c => c + 1);
      setIsFlipped(false);
    } else setView('home');
  };

  return (
    <div className="min-h-screen bg-[#F5F5F7] text-[#1D1D1F] font-sans selection:bg-[#E5E5E5] overflow-x-hidden">
      
      {/* Background Decor */}
      <div className="fixed inset-0 pointer-events-none z-0">
        <div className="absolute top-0 right-0 w-1/2 h-1/2 bg-gradient-to-bl from-gray-200/40 to-transparent blur-[120px]"></div>
        <div className="absolute bottom-0 left-0 w-1/2 h-1/2 bg-gradient-to-tr from-[#D4C3B3]/20 to-transparent blur-[120px]"></div>
      </div>

      {/* Navigation */}
      <nav className="relative z-10 flex justify-between items-center p-8 px-12 border-b border-gray-200 bg-white/40 backdrop-blur-xl">
        <div className="flex items-center gap-6 cursor-pointer" onClick={() => setView('home')}>
          <h1 className="text-2xl font-light tracking-[0.4em] uppercase border-b border-black pb-1">Archive</h1>
          <span className="text-[10px] font-medium tracking-[0.2em] text-gray-400 mt-2">STUDY EDIT</span>
        </div>
        
        <div className="flex items-center gap-8">
          <button onClick={() => setView('burnbook')} className="text-[11px] font-bold tracking-widest uppercase hover:opacity-50 transition-opacity flex items-center gap-2">
            The Archive ({mistakes.length})
          </button>
        </div>
      </nav>

      <main className="relative z-10 max-w-6xl mx-auto px-6 py-16">
        
        {/* Home View */}
        {view === 'home' && (
          <div className="space-y-24 animate-in fade-in duration-1000">
            <header className="space-y-6 text-center">
              <h2 className="text-7xl md:text-9xl font-light tracking-tighter leading-none italic font-serif">Effortless.</h2>
              <p className="text-xs font-bold uppercase tracking-[0.6em] text-gray-400">Master your craft with intention</p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-12">
              {SUBJECTS.map((sub) => (
                <div key={sub.id} className="group relative space-y-8 p-4 transition-all hover:-translate-y-2">
                  <div className={`aspect-[3/4] rounded-sm bg-gradient-to-br ${sub.color} shadow-2xl relative overflow-hidden flex flex-col justify-end p-8 text-white`}>
                    <div className="absolute top-8 right-8 opacity-40">{sub.icon}</div>
                    <div className="relative z-10 space-y-2">
                      <span className="text-[10px] font-bold tracking-[0.4em] opacity-60 uppercase">{sub.label}</span>
                      <h3 className="text-4xl font-light tracking-tight italic font-serif">{sub.name}</h3>
                    </div>
                  </div>

                  <div className="space-y-6 px-2">
                    <div className="flex justify-between text-[10px] font-bold tracking-widest text-gray-400 border-b border-gray-100 pb-2 uppercase">
                      <span>Data Pool</span>
                      <span className="text-black font-medium">{db[sub.id].questions.length + db[sub.id].cards.length} Items</span>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <button onClick={() => { setActiveSubject(sub); startSession('all', 'questions'); }} className="py-4 bg-black text-white text-[10px] font-bold tracking-widest uppercase hover:bg-gray-800 transition shadow-lg">Practice</button>
                      <button onClick={() => { setActiveSubject(sub); setView('flash-options'); }} className="py-4 border border-black text-black text-[10px] font-bold tracking-widest uppercase hover:bg-black hover:text-white transition">Cards</button>
                    </div>
                    <button onClick={() => { setActiveSubject(sub); setView('input'); }} className="w-full text-[10px] font-bold tracking-widest text-gray-300 hover:text-black transition uppercase">+ Import Notes</button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Flashcard Filters View */}
        {view === 'flash-options' && (
          <div className="max-w-xl mx-auto space-y-12 animate-in slide-in-from-bottom-8">
             <button onClick={() => setView('home')} className="flex items-center gap-4 text-gray-400 font-bold uppercase text-[10px] tracking-widest transition hover:text-black">
              <ChevronLeft size={16} /> Back to Library
            </button>
            <div className="bg-white p-12 border border-gray-100 shadow-sm space-y-10">
                <h2 className="text-3xl font-light italic font-serif border-b border-gray-50 pb-6">Focus Session</h2>
                <div className="space-y-6">
                  {['all', 'forgotten', 'blurred'].map(mode => (
                    <button key={mode} onClick={() => startSession(mode, 'cards')} className="w-full group flex justify-between items-center py-4 border-b border-gray-100 hover:border-black transition-all">
                      <span className={`text-[11px] font-bold tracking-[0.3em] uppercase ${mode === 'forgotten' ? 'text-stone-400' : 'text-gray-900'}`}>{mode} Signals</span>
                      <div className="text-[10px] font-medium text-gray-300 group-hover:text-black">
                        {mode === 'all' ? db[activeSubject.id].cards.length : db[activeSubject.id].cards.filter(c => c.status === mode).length} Items
                      </div>
                    </button>
                  ))}
                </div>
            </div>
          </div>
        )}

        {/* Input View */}
        {view === 'input' && (
          <div className="max-w-4xl mx-auto animate-in fade-in">
             <button onClick={() => setView('home')} className="mb-10 flex items-center gap-4 text-gray-400 font-bold uppercase text-[10px] tracking-widest hover:text-black">
              <ChevronLeft size={16} /> Cancel
            </button>
            <div className="bg-white p-12 md:p-16 border border-gray-100 space-y-12 shadow-sm">
                <div className="flex flex-col md:flex-row justify-between items-end gap-6">
                  <div className="space-y-2">
                    <span className="text-[10px] font-bold text-gray-300 uppercase tracking-widest">Workspace</span>
                    <h2 className="text-4xl font-light italic font-serif">Import: {activeSubject.name}</h2>
                  </div>
                  <div className="flex border border-gray-100 p-1">
                    {['question', 'card'].map(t => (
                      <button key={t} onClick={() => setImportType(t)} className={`px-8 py-3 text-[10px] font-bold tracking-widest uppercase transition-all ${importType === t ? 'bg-black text-white shadow-md' : 'text-gray-300'}`}>{t}s</button>
                    ))}
                  </div>
                </div>
                <div className="relative">
                  <textarea 
                    value={rawText}
                    onChange={(e) => setRawText(e.target.value)}
                    placeholder="Paste raw content or Excel cells here. Our minimalist engine will curate it for you."
                    className="w-full h-80 bg-[#FAFAFA] border-none rounded-none p-10 focus:ring-0 outline-none text-sm font-medium leading-relaxed placeholder:text-gray-200 resize-none shadow-inner"
                  />
                  <div className="absolute bottom-6 right-8 text-gray-200"><FileSpreadsheet size={16}/></div>
                </div>
                <button 
                  disabled={isParsing || !rawText} 
                  onClick={parseData} 
                  className="w-full py-6 bg-black text-white text-[11px] font-bold tracking-[0.4em] uppercase hover:bg-gray-800 disabled:opacity-20 transition-all flex items-center justify-center gap-4"
                >
                  {isParsing ? <RefreshCw className="animate-spin" size={16} /> : <Sparkles size={16} />}
                  {isParsing ? 'Processing' : 'Generate Edit'}
                </button>
            </div>
          </div>
        )}

        {/* Quiz Session View */}
        {view === 'questions' && activeItems.length > 0 && (
          <div className="max-w-3xl mx-auto animate-in fade-in">
            <div className="flex justify-between items-end mb-12">
              <span className="text-[10px] font-bold uppercase tracking-[0.5em] text-gray-300 font-medium">Section {currentIdx + 1} // {activeItems.length}</span>
              <button onClick={() => setView('home')} className="text-[10px] font-bold uppercase text-gray-300 hover:text-black transition">Quit</button>
            </div>
            
            <div className="bg-white border border-gray-100 p-12 md:p-20 space-y-16 shadow-lg relative">
              <div className="absolute top-0 left-0 h-1 bg-black transition-all duration-700" style={{ width: `${((currentIdx+1)/activeItems.length)*100}%` }}></div>
              <p className="text-4xl font-light italic font-serif leading-tight text-gray-900">{activeItems[currentIdx].question}</p>
              
              <div className="space-y-4">
                {activeItems[currentIdx].type !== 'open' ? (
                  activeItems[currentIdx].options.map((opt, i) => {
                    const isCorrect = i === activeItems[currentIdx].correct;
                    const isSel = selectedIdx === i;
                    let style = "border-gray-50 bg-[#FAFAFA] hover:bg-gray-100";
                    if (quizAnswered) {
                      if (isCorrect) style = "border-black bg-black text-white";
                      else if (isSel) style = "border-gray-200 bg-gray-50 text-gray-300";
                      else style = "opacity-20";
                    }
                    return (
                      <button key={i} disabled={quizAnswered} onClick={() => handleQuizAnswer(i)} className={`w-full text-left p-6 border text-sm font-medium transition-all flex justify-between items-center ${style}`}>
                        {opt} {quizAnswered && isCorrect && <Check size={16} />}
                      </button>
                    )
                  })
                ) : (
                  <div className="space-y-8">
                    {!quizAnswered ? (
                      <button onClick={() => setQuizAnswered(true)} className="w-full py-20 border border-dashed border-gray-200 text-gray-300 font-bold uppercase tracking-[0.3em] hover:text-black hover:border-black transition-all flex flex-col items-center gap-4"><Eye size={24} /> Reveal Insight</button>
                    ) : (
                      <div className="p-10 bg-[#FAFAFA] border border-gray-100 animate-in slide-in-from-top-4 shadow-inner">
                        <span className="text-[10px] font-bold text-gray-300 uppercase mb-4 block tracking-widest">Archive Answer:</span>
                        <p className="text-xl font-light italic font-serif leading-relaxed">"{activeItems[currentIdx].correct}"</p>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {quizAnswered && (
                <div className="pt-12 border-t border-gray-50 animate-in slide-in-from-top-4 space-y-10">
                  <div className="text-[11px] leading-loose text-gray-400 italic">"Note: {activeItems[currentIdx].logic}"</div>
                  <button onClick={() => {
                    if(currentIdx+1 < activeItems.length) {
                      setCurrentIdx(c => c + 1); setQuizAnswered(false); setSelectedIdx(null);
                    } else setView('home');
                  }} className="w-full py-6 bg-black text-white text-[11px] font-bold tracking-[0.4em] uppercase hover:bg-gray-800 transition flex items-center justify-center gap-4 shadow-xl">Proceed <ArrowRight size={16}/></button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Flashcard View */}
        {view === 'cards' && activeItems.length > 0 && (
          <div className="max-w-2xl mx-auto animate-in slide-in-from-top-12">
            <div className="flex justify-between items-center mb-10">
              <span className="text-[10px] font-bold uppercase tracking-[0.5em] text-gray-300 font-medium">Look {currentIdx + 1} / {activeItems.length}</span>
              <button onClick={() => setView('home')} className="text-[10px] font-bold uppercase text-gray-300 hover:text-black transition">Close</button>
            </div>
            
            <div className="perspective-1000">
              <div onClick={() => setIsFlipped(!isFlipped)} className={`relative h-[550px] w-full transition-all duration-1000 preserve-3d cursor-pointer ${isFlipped ? 'rotate-y-180' : ''}`}>
                {/* Front */}
                <div className="absolute inset-0 backface-hidden bg-white border border-gray-100 shadow-xl p-16 flex flex-col items-center justify-center text-center">
                   <div className="absolute top-12 left-1/2 -translate-x-1/2"><Circle size={12} className="text-gray-100 animate-pulse" /></div>
                   <p className="text-3xl font-light italic font-serif text-gray-900 leading-snug">{activeItems[currentIdx].front}</p>
                   <div className="absolute bottom-16 flex flex-col items-center gap-3">
                     <span className="font-bold text-[9px] text-gray-200 tracking-[0.5em] uppercase">Click to Reveal</span>
                   </div>
                </div>
                {/* Back */}
                <div className="absolute inset-0 backface-hidden rotate-y-180 bg-black border border-black shadow-2xl p-16 flex flex-col items-center justify-center text-center">
                   <p className="text-4xl font-light italic font-serif text-white leading-tight mb-10">{activeItems[currentIdx].back}</p>
                   <p className="text-[11px] font-medium text-gray-500 leading-loose max-w-[80%] italic">
                     "{activeItems[currentIdx].logic}"
                   </p>
                </div>
              </div>
            </div>

            <div className={`mt-16 flex gap-6 transition-all duration-1000 ${isFlipped ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-10 scale-95 pointer-events-none'}`}>
              <button onClick={() => updateCardStatus('forgotten')} className="flex-1 py-5 border border-gray-200 text-[10px] font-bold tracking-[0.3em] uppercase hover:bg-black hover:text-white transition flex flex-col items-center gap-2"><Frown size={16}/> Forgotten</button>
              <button onClick={() => updateCardStatus('blurred')} className="flex-1 py-5 border border-gray-100 text-[10px] font-bold tracking-[0.3em] uppercase hover:bg-black hover:text-white transition flex flex-col items-center gap-2"><Meh size={16}/> Blurred</button>
              <button onClick={() => updateCardStatus('mastered')} className="flex-1 py-5 bg-black text-white text-[10px] font-bold tracking-[0.3em] uppercase transition flex flex-col items-center gap-2"><Smile size={16}/> Mastered</button>
            </div>
          </div>
        )}

        {/* Archive / Burn Book View */}
        {view === 'burnbook' && (
          <div className="max-w-5xl mx-auto animate-in fade-in">
             <header className="flex justify-between items-end mb-20 border-b border-gray-200 pb-10">
                <h2 className="text-6xl font-light italic font-serif">The Archive</h2>
                <button onClick={() => setView('home')} className="text-[10px] font-bold uppercase tracking-[0.4em] hover:opacity-50 transition">Return</button>
             </header>
             {mistakes.length === 0 ? (
               <div className="text-center py-40 border border-dashed border-gray-100 text-gray-200 font-bold text-sm uppercase tracking-[0.6em]">Clean Slate // Zero Entries</div>
             ) : (
               <div className="grid gap-12">
                 {mistakes.map((m, i) => (
                   <div key={i} className="bg-white border border-gray-50 p-12 transition-all hover:shadow-xl group relative overflow-hidden">
                      <div className="flex justify-between items-start mb-8 relative z-10">
                        <span className="text-[9px] font-bold tracking-[0.5em] text-gray-300 uppercase">Entry {i+1}</span>
                        <button onClick={() => setMistakes(prev => prev.filter(item => item.id !== m.id))} className="text-gray-200 hover:text-black transition"><Trash2 size={16} /></button>
                      </div>
                      <p className="text-3xl font-light italic font-serif text-gray-900 mb-10 leading-tight relative z-10">{m.question}</p>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-10 relative z-10">
                        <div className="space-y-4">
                          <span className="text-[9px] font-bold text-gray-300 uppercase tracking-widest block">Reference</span>
                          <p className="text-lg font-medium text-gray-700 italic border-l border-black pl-6">{m.type === 'open' ? m.correct : m.options[m.correct]}</p>
                        </div>
                        <div className="space-y-4">
                          <span className="text-[9px] font-bold text-gray-300 uppercase tracking-widest block">Context</span>
                          <p className="text-xs leading-loose text-gray-400">"{m.logic}"</p>
                        </div>
                      </div>
                   </div>
                 ))}
               </div>
             )}
          </div>
        )}

      </main>

      {/* Aesthetic Overrides */}
      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&display=swap');
        
        .font-serif { font-family: 'Playfair Display', serif; }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #F5F5F7; }
        ::-webkit-scrollbar-thumb { background: #D1D1D1; }
        ::-webkit-scrollbar-thumb:hover { background: #8E8E93; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      `}} />
    </div>
  );
};

export default App;
